=== FX27 AUDIT (READ-ONLY) ===
DATE: 12/22/2025 14:12:23
PATH: C:\Users\timon\Downloads\izzi_sync
GIT:  7a0ca046

=== 1) INVENTARIO ===
--- src/components/fx27 (*.tsx) ---
- AdminCarrollModule.tsx | 12/13/2025 12:41:14
- AdministracionCarroll.tsx | 12/13/2025 12:41:14
- AgregarLeadModule_LIGHT.tsx | 12/13/2025 12:41:14
- AgregarLeadModule.tsx | 12/14/2025 01:01:12
- AIAssistant.tsx | 11/27/2025 11:42:43
- AutocompleteInput.tsx | 11/27/2025 11:42:43
- Button.tsx | 11/27/2025 11:42:43
- CarrollConfigModule.tsx | 11/27/2025 11:42:43
- CarrollModule.tsx | 12/13/2025 12:41:14
- CarrollModuleFinal.tsx | 12/19/2025 01:26:33
- CarrollModuleFinalV2.tsx | 11/27/2025 11:42:43
- CarrollModuleFinalV2Compact.tsx | 12/13/2025 12:41:14
- CatalogoFormatosVenta.tsx | 12/13/2025 12:41:14
- ConfiguracionModule.tsx | 11/27/2025 11:42:43
- ControlEquipoModule.tsx | 11/27/2025 11:42:43
- CotizacionesModule.tsx | 11/27/2025 11:42:43
- DashboardCard.tsx | 11/27/2025 11:42:43
- DashboardScreen.tsx | 11/27/2025 11:42:43
- DashboardWidgets.tsx | 11/27/2025 11:42:43
- DedicadosHub.tsx | 12/13/2025 12:41:14
- DedicadosModule.tsx | 12/13/2025 12:41:14
- DedicadosModuleWideTech.tsx | 12/19/2025 12:02:14
- DespachoInteligenteContent.tsx | 12/21/2025 11:29:18
- DespachoInteligenteModule.tsx | 12/18/2025 14:00:48
- EjemploUbicacionesInteligentes.tsx | 11/27/2025 11:42:43
- EjemploUbicacionGPS.tsx | 11/27/2025 11:42:43
- FormatosVentaHub.tsx | 12/13/2025 12:41:14
- Input.tsx | 11/27/2025 11:42:43
- KPIsModule.tsx | 11/27/2025 11:42:43
- LoginScreen.tsx | 12/13/2025 15:17:07
- MapaClim aticoCarroll.tsx | 11/27/2025 11:42:43
- MapaClimaticoCarroll.tsx | 11/27/2025 11:42:43
- MapaFlota.tsx | 11/27/2025 11:42:43
- MapaFlotaGoogleMaps.tsx | 11/27/2025 11:42:43
- ModuleTemplate.tsx | 12/13/2025 15:17:05
- NewsTicker.tsx | 11/27/2025 11:42:43
- NuevoFormatoVenta.tsx | 12/13/2025 12:41:14
- PanelOportunidadesModule.tsx | 12/17/2025 12:21:17
- ServicioClientesModule.tsx | 11/27/2025 11:42:43
- UbicacionDetallada.tsx | 11/27/2025 11:42:43
- UbicacionGPS.tsx | 11/27/2025 11:42:43
- UbicacionInteligenteCompacta.tsx | 11/27/2025 11:42:43
- UsuariosModule.tsx | 12/13/2025 12:41:14
- UtileriasModule.tsx | 11/27/2025 11:42:43
- VariablesCotizacionModule.tsx | 11/27/2025 11:42:43
- VentasModule.tsx | 12/22/2025 13:41:54
- VerificadorGoogleMapsAPI.tsx | 11/27/2025 11:42:43
- VistaClientesCarroll.tsx | 12/13/2025 12:41:14

=== 2) APP ROUTER (m√≥dulos/roles/sesi√≥n) ===
FILE: .\src\App.tsx
42: type UserRole = 'admin' | 'ventas' | 'operaciones' | 'csr' | 'custom';
52:   vendedorVentas?: string;
54:   vendedorLeads?: string;
62: const USUARIOS_AUTORIZADOS: Usuario[] = [
123:     vendedorVentas: 'ISIS',        // Valor en ventas_maestro.ejecutivo_ventas
124:     vendedorLeads: 'Isis Estrada', // Valor en leads.vendedor (nombre completo)
136:     vendedorVentas: 'PALOMA',      // Valor en ventas_maestro.ejecutivo_ventas
137:     vendedorLeads: 'Paloma Oliva', // Valor en leads.vendedor (nombre completo)
184:   const [userVendedorVentas, setUserVendedorVentas] = useState<string>('');   // Para m√≥dulo Ventas
185:   const [userVendedorLeads, setUserVendedorLeads] = useState<string>('');     // Para Panel Oportunidades
187:   const [currentModule, setCurrentModule] = useState<string | null>(null);
195:     localStorage.setItem('fx27-usuarios', JSON.stringify(USUARIOS_AUTORIZADOS));
197:     const savedSession = localStorage.getItem('fx27-session');
201:         const usuario = USUARIOS_AUTORIZADOS.find(u => u.correo === session.email && u.activo);
206:           setUserVendedorVentas(usuario.vendedorVentas || '');
207:           setUserVendedorLeads(usuario.vendedorLeads || '');
211:           console.log('‚úÖ Sesi√≥n restaurada:', usuario.nombre, '| Ventas:', usuario.vendedorVentas || 'TODO', '| Leads:', usuario.vendedorLeads || 'TODO');
213:           localStorage.removeItem('fx27-session');
216:         localStorage.removeItem('fx27-session');
226:     const usuario = USUARIOS_AUTORIZADOS.find(u => 
236:     console.log('   ‚Üí Ventas filtro:', usuario.vendedorVentas || 'VER TODO');
237:     console.log('   ‚Üí Leads filtro:', usuario.vendedorLeads || 'VER TODO');
241:     setUserVendedorVentas(usuario.vendedorVentas || '');
242:     setUserVendedorLeads(usuario.vendedorLeads || '');
248:     localStorage.setItem('fx27-session', JSON.stringify({
251:       vendedorVentas: usuario.vendedorVentas || '',
252:       vendedorLeads: usuario.vendedorLeads || '',
269:     setCurrentModule(null);
272:     setUserVendedorVentas('');
273:     setUserVendedorLeads('');
277:     localStorage.removeItem('fx27-session');
285:     setCurrentModule(module);
288:   const handleBack = () => setCurrentModule(null);
306:       ) : currentModule ? (
308:           {currentModule === 'agregar-lead' && <AgregarLeadModule onBack={handleBack} />}
309:           {currentModule === 'panel-oportunidades' && (
312:               userVendedorLeads={userVendedorLeads}  // Nombre completo para filtrar leads
315:           {currentModule === 'operaciones' && <ModuleTemplate title="Operaciones" onBack={handleBack} headerImage={MODULE_IMAGES.OPERACIONES} />}
316:           {currentModule === 'despacho-inteligente' && <DespachoInteligenteModule onBack={handleBack} />}
317:           {currentModule === 'control-equipo' && <ControlEquipoModule onBack={handleBack} />}
318:           {currentModule === 'kpis' && <KPIsModule onBack={handleBack} />}
319:           {currentModule === 'configuracion' && <ConfiguracionModule onBack={handleBack} />}
320:           {currentModule === 'cotizaciones' && <CotizacionesModule onBack={handleBack} />}
321:           {currentModule === 'ventas' && <VentasModule onBack={handleBack} userEmail={currentUserEmail} />}
322:           {currentModule === 'utilerias' && <UtileriasModule onBack={handleBack} />}
323:           {currentModule === 'servicio-clientes' && <ServicioClientesModule onBack={handleBack} />}
324:           {currentModule === 'dedicados' && (
325:             <DedicadosHub onBack={handleBack} onNavigate={(submodule) => setCurrentModule(submodule)} />
327:           {currentModule === 'admin-carroll' && <CarrollModuleFinalV2Compact onBack={() => setCurrentModule('dedicados')} />}
328:           {currentModule === 'monitor-carroll' && <DedicadosModuleWideTech onBack={() => setCurrentModule('dedicados')} />}
329:           {currentModule === 'vista-clientes-carroll' && <VistaClientesCarroll onBack={() => setCurrentModule('dedicados')} />}
330:           {currentModule === 'mapa-climatico-carroll' && <MapaClimaticoCarroll onBack={() => setCurrentModule('dedicados')} />}

=== 3) ESCANEO POR M√ìDULO (BD / Edge / Timers / Permisos) ===
==================== AdminCarrollModule.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
4: interface AdminCarrollModuleProps {
29: // üöõ 30 CAMIONES CARROLL - N√öMEROS ECON√ìMICOS REALES
30: const UNIDADES_CARROLL: Unidad[] = [
63: export const AdminCarrollModule = ({ onBack }: AdminCarrollModuleProps) => {
65:   const [unidades, setUnidades] = useState<Unidad[]>(UNIDADES_CARROLL);
147:                   ADMINISTRACI√ìN CARROLL
190:                 FLOTA CARROLL - 30 UNIDADES
385:                 <div className="text-slate-500 mt-1" style={{ fontSize: '10px' }}>PDF - Nombrar: SUA_Carroll_FECHA.pdf</div>
393:                 <div className="text-slate-500 mt-1" style={{ fontSize: '10px' }}>PDF - Nombrar: CSF_Carroll_FECHA.pdf</div>
401:                 <div className="text-slate-500 mt-1" style={{ fontSize: '10px' }}>PDF - Nombrar: Opinion_Carroll_FECHA.pdf</div>
409:                 <div className="text-slate-500 mt-1" style={{ fontSize: '10px' }}>PDF - Nombrar: Poliza_Carroll_UNIDAD.pdf</div>
428:                 <li>‚Ä¢ <span style={{ fontWeight: 700 }}>SUA/CSF/Opini√≥n:</span> TIPO_Carroll_2024-11-12.pdf</li>

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
306:                           <div className="text-slate-500" style={{ fontSize: '10px' }}>Operador, Tracto, Thermo, Placas</div>


==================== AdministracionCarroll.tsx ====================
-- pattern: functions\/v1
52:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/unidades`,
72:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/geocercas`,
91:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/unidades`,
118:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/unidades/${numeroTracto}`,
136:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/geocercas`,
163:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/geocercas/${id}`,

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
5: interface AdministracionCarrollProps {
25: export const AdministracionCarroll = ({ onBack }: AdministracionCarrollProps) => {
52:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/unidades`,
72:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/geocercas`,
91:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/unidades`,
118:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/unidades/${numeroTracto}`,
136:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/geocercas`,
163:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/geocercas/${id}`,
191:               Administraci√≥n Carroll


==================== AgregarLeadModule_LIGHT.tsx ====================
-- pattern: functions\/v1
181:       const checkResponse = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`, {
235:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`, {

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
126:         const usuarios = JSON.parse(localStorage.getItem('fx27-usuarios') || '[]');
127:         const usuario = usuarios.find((u: any) => u.correo === email);

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
38:   vendedor: string;
114:     vendedor: '',
129:           setFormData(prev => ({ ...prev, vendedor: usuario.nombre }));
132:         console.error('Error al obtener vendedor');
181:       const checkResponse = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`, {
190:         const empresaExistente = checkResult.leads.find(
195:           alert(`‚ùå EMPRESA DUPLICADA\n\nLa empresa "${formData.nombreEmpresa}" ya existe en el sistema.\n\nüìã Detalles:\n‚Ä¢ Registrada por: ${empresaExistente.vendedor}\n‚Ä¢ Fecha: ${new Date(empresaExistente.fechaCaptura).toLocaleDateString('es-MX')}\n‚Ä¢ Contacto: ${empresaExistente.nombreContacto || 'Sin contacto'}\n\nüí° Verifica en el Panel de Oportunidades.`);
226:       vendedor: formData.vendedor!,
235:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`, {
275:         vendedor: formData.vendedor,
288:     <ModuleTemplate 
1418:                   Vendedor:
1428:                   {formData.vendedor || 'No asignado'}
1466:     </ModuleTemplate>


==================== AgregarLeadModule.tsx ====================
-- pattern: functions\/v1
72:       const chk = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`, { headers: { 'Authorization': `Bearer ${publicAnonKey}` } });
78:       const r = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${publicAnonKey}` }, body: JSON.stringify(lead) });

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
57:     if (session) { try { const { email } = JSON.parse(session); const usuarios = JSON.parse(localStorage.getItem('fx27-usuarios') || '[]'); const u = usuarios.find((x: any) => x.correo === email); if (u) setFormData(p => ({ ...p, vendedor: u.nombre })); } catch {} }

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
27: interface Lead { id: string; nombreEmpresa: string; paginaWeb: string; nombreContacto: string; telefonoContacto: string; correoElectronico: string; tipoEmpresa: string; ciudad: string; estado: string; prioridad: string; tamanoEmpresa: string; fechaEstimadaCierre: string; tipoServicio: string[]; tipoViaje: string[]; transbordo: boolean; dtd: boolean; principalesRutas: string; viajesPorMes: string; tarifa: string; proyectadoVentaMensual: string; proximosPasos: string; etapaLead: string; altaCliente: boolean; generacionSOP: boolean; juntaArranque: boolean; facturado: boolean; vendedor: string; fechaCaptura: string; }
53:   const [formData, setFormData] = useState<Partial<Lead>>({ nombreEmpresa: '', paginaWeb: '', nombreContacto: '', telefonoContacto: '', correoElectronico: '', tipoEmpresa: '', ciudad: '', estado: '', prioridad: 'üü° Media', tamanoEmpresa: '', fechaEstimadaCierre: '', tipoServicio: [], tipoViaje: [], transbordo: false, dtd: false, principalesRutas: '', viajesPorMes: '', tarifa: '', proyectadoVentaMensual: '', proximosPasos: '', etapaLead: 'Prospecto', vendedor: '', altaCliente: false, generacionSOP: false, juntaArranque: false, facturado: false });
57:     if (session) { try { const { email } = JSON.parse(session); const usuarios = JSON.parse(localStorage.getItem('fx27-usuarios') || '[]'); const u = usuarios.find((x: any) => x.correo === email); if (u) setFormData(p => ({ ...p, vendedor: u.nombre })); } catch {} }
72:       const chk = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`, { headers: { 'Authorization': `Bearer ${publicAnonKey}` } });
74:       if (chk.ok && res.success) { const ex = res.leads.find((l: Lead) => l.nombreEmpresa.toLowerCase().trim() === formData.nombreEmpresa!.toLowerCase().trim()); if (ex) { alert(`‚ùå DUPLICADA: "${formData.nombreEmpresa}" ya existe (${ex.vendedor})`); return; } }
76:     const lead: Lead = { id: Date.now().toString(), nombreEmpresa: formData.nombreEmpresa!, paginaWeb: formData.paginaWeb || '', nombreContacto: formData.nombreContacto || '', telefonoContacto: formData.telefonoContacto || '', correoElectronico: formData.correoElectronico || '', tipoEmpresa: formData.tipoEmpresa || '', ciudad: formData.ciudad || '', estado: formData.estado || '', prioridad: formData.prioridad || 'üü° Media', tamanoEmpresa: formData.tamanoEmpresa || '', fechaEstimadaCierre: formData.fechaEstimadaCierre || '', tipoServicio: formData.tipoServicio || [], tipoViaje: formData.tipoViaje || [], transbordo: formData.transbordo || false, dtd: formData.dtd || false, principalesRutas: formData.principalesRutas || '', viajesPorMes: formData.viajesPorMes || '', tarifa: formData.tarifa || '', proyectadoVentaMensual: formData.proyectadoVentaMensual || '', proximosPasos: formData.proximosPasos || '', etapaLead: 'Prospecto', vendedor: formData.vendedor!, fechaCaptura: new Date().toISOString(), altaCliente: formData.altaCliente || false, generacionSOP: formData.generacionSOP || false, juntaArranque: formData.juntaArranque || false, facturado: formData.facturado || false };
78:       const r = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${publicAnonKey}` }, body: JSON.stringify(lead) });
81:       setFormData({ nombreEmpresa: '', paginaWeb: '', nombreContacto: '', telefonoContacto: '', correoElectronico: '', tipoEmpresa: '', ciudad: '', estado: '', prioridad: 'üü° Media', tamanoEmpresa: '', fechaEstimadaCierre: '', tipoServicio: [], tipoViaje: [], transbordo: false, dtd: false, principalesRutas: '', viajesPorMes: '', tarifa: '', proyectadoVentaMensual: '', proximosPasos: '', etapaLead: 'Prospecto', vendedor: formData.vendedor, altaCliente: false, generacionSOP: false, juntaArranque: false, facturado: false });
113:     <ModuleTemplate title="Agregar Lead" onBack={onBack} headerImage={MODULE_IMAGES.AGREGAR_LEAD}>
149:           <div style={{ flex: 1, padding: '12px', display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px', minHeight: 0 }}>
160:               <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
166:               <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
175:               <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
181:               <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' }}>
193:                 <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
201:                 <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
224:                   <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
258:             {/* Vendedor + Fecha */}
260:               <span style={{ color: 'rgba(148,163,184,0.90)', fontSize: '13px' }}>Vendedor: <span style={{ color: 'rgba(255,255,255,0.95)', fontWeight: 600 }}>{formData.vendedor || '...'}</span></span>
275:     </ModuleTemplate>


==================== AIAssistant.tsx ====================
-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
99:     setTimeout(async () => {

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
6:   role: 'user' | 'assistant' | 'system';
16:       role: 'assistant',
25:   const scrollToBottom = () => {
26:     messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
30:     scrollToBottom();
39:       'kpi', 'dashboard', 'modulo', 'carroll', 'dedicados', 'refrigerado', 'congelado',
41:       'administracion', 'configuracion', 'usuario', 'rol', 'permiso', 'fx27', 'sistema',
55:     if (messageLower.includes('dedicados') || messageLower.includes('carroll')) {
56:       return 'El m√≥dulo **Dedicados** es espec√≠fico para Granjas Carroll. Incluye 3 vistas:\n\n1. **Administraci√≥n Carroll** (Operaciones): Gesti√≥n completa de las 26 unidades dedicadas, creaci√≥n de viajes, asignaci√≥n de rutas.\n\n2. **Monitor Carroll** (Desarrollo): Seguimiento en tiempo real, KPIs, alertas y control de temperatura.\n\n3. **Vista Clientes** (Cliente): Vista de solo consulta para que el cliente vea el estatus de sus embarques.\n\n¬øNecesitas ayuda con alguna funcionalidad espec√≠fica?';
60:       return 'Para agregar un viaje en el m√≥dulo Dedicados:\n\n1. Accede a **Administraci√≥n Carroll**\n2. Haz clic en el bot√≥n **"+ Nuevo Viaje"**\n3. Completa los campos: Unidad, Remolque, Origen, Destino, Tipo de carga, Temperatura requerida\n4. El sistema valida autom√°ticamente que no haya duplicados\n5. Guarda y el viaje quedar√° registrado con trazabilidad completa\n\n¬øNecesitas m√°s detalles?';
64:       return 'El sistema monitorea temperatura en tiempo real para cargas refrigeradas y congeladas:\n\n‚Ä¢ **Refrigerado**: 0¬∞C a 4¬∞C\n‚Ä¢ **Congelado**: -18¬∞C a -25¬∞C\n\nSi la temperatura sale del rango, se genera una **alerta autom√°tica** visible en el Monitor Carroll. El cliente tambi√©n puede ver la temperatura actual en su Vista de Clientes.\n\n¬øQuieres saber m√°s sobre alertas?';
71:     if (messageLower.includes('usuario') || messageLower.includes('rol') || messageLower.includes('permiso')) {
72:       return 'El sistema FX27 tiene 4 roles de usuario:\n\n1. **Administrador**: Acceso total a todos los m√≥dulos\n2. **Ventas**: Acceso a leads, oportunidades, cotizaciones\n3. **Operaciones**: Acceso a operaciones, despacho, equipos\n4. **Custom**: Permisos personalizados seg√∫n necesidades\n\nLos permisos se configuran en el m√≥dulo **Configuraci√≥n** (solo administradores).\n\n¬øNecesitas ayuda con la configuraci√≥n?';
76:       return 'Desde el **Dashboard principal** puedes acceder a todos los m√≥dulos:\n\nüîπ **M√≥dulos principales:**\n‚Ä¢ Agregar Lead\n‚Ä¢ Panel de Oportunidades\n‚Ä¢ Operaciones\n‚Ä¢ Despacho Inteligente\n‚Ä¢ Control de Equipo\n‚Ä¢ KPIs\n‚Ä¢ Configuraci√≥n\n‚Ä¢ Cotizaciones\n‚Ä¢ Ventas\n‚Ä¢ Utiler√≠as\n‚Ä¢ Servicio a Clientes\n‚Ä¢ Dedicados\n\nSimplemente haz clic en cualquier tarjeta para acceder. ¬øQu√© m√≥dulo te interesa?';
80:     return 'Entiendo tu pregunta sobre el sistema. Puedo ayudarte con:\n\n‚Ä¢ **M√≥dulos**: C√≥mo usar cada secci√≥n del CRM\n‚Ä¢ **Operaciones**: Crear viajes, asignar unidades, rutas\n‚Ä¢ **Log√≠stica**: Seguimiento, KPIs, reportes\n‚Ä¢ **Clientes**: Gesti√≥n de leads, oportunidades, cotizaciones\n‚Ä¢ **Equipos**: Control de tractocamiones y remolques\n‚Ä¢ **Configuraci√≥n**: Usuarios, roles y permisos\n\n¬øPodr√≠as darme m√°s detalles de lo que necesitas?';
89:       role: 'user',
104:         role: 'assistant',
237:                 className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
242:                     background: message.role === 'user' 
245:                     border: message.role === 'assistant' ? '1px solid #323A46' : 'none'

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
72:       return 'El sistema FX27 tiene 4 roles de usuario:\n\n1. **Administrador**: Acceso total a todos los m√≥dulos\n2. **Ventas**: Acceso a leads, oportunidades, cotizaciones\n3. **Operaciones**: Acceso a operaciones, despacho, equipos\n4. **Custom**: Permisos personalizados seg√∫n necesidades\n\nLos permisos se configuran en el m√≥dulo **Configuraci√≥n** (solo administradores).\n\n¬øNecesitas ayuda con la configuraci√≥n?';
76:       return 'Desde el **Dashboard principal** puedes acceder a todos los m√≥dulos:\n\nüîπ **M√≥dulos principales:**\n‚Ä¢ Agregar Lead\n‚Ä¢ Panel de Oportunidades\n‚Ä¢ Operaciones\n‚Ä¢ Despacho Inteligente\n‚Ä¢ Control de Equipo\n‚Ä¢ KPIs\n‚Ä¢ Configuraci√≥n\n‚Ä¢ Cotizaciones\n‚Ä¢ Ventas\n‚Ä¢ Utiler√≠as\n‚Ä¢ Servicio a Clientes\n‚Ä¢ Dedicados\n\nSimplemente haz clic en cualquier tarjeta para acceder. ¬øQu√© m√≥dulo te interesa?';
80:     return 'Entiendo tu pregunta sobre el sistema. Puedo ayudarte con:\n\n‚Ä¢ **M√≥dulos**: C√≥mo usar cada secci√≥n del CRM\n‚Ä¢ **Operaciones**: Crear viajes, asignar unidades, rutas\n‚Ä¢ **Log√≠stica**: Seguimiento, KPIs, reportes\n‚Ä¢ **Clientes**: Gesti√≥n de leads, oportunidades, cotizaciones\n‚Ä¢ **Equipos**: Control de tractocamiones y remolques\n‚Ä¢ **Configuraci√≥n**: Usuarios, roles y permisos\n\n¬øPodr√≠as darme m√°s detalles de lo que necesitas?';


==================== AutocompleteInput.tsx ====================
-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
55:           const checkInterval = setInterval(() => {
76:           const checkReady = setInterval(() => {


==================== Button.tsx ====================

==================== CarrollConfigModule.tsx ====================
-- pattern: functions\/v1
48:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/config`,
72:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/eta-params`,
114:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/upload`,
155:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/upload`,

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
6: interface CarrollConfigModuleProps {
18: interface CarrollData {
33: export const CarrollConfigModule = ({ onBack }: CarrollConfigModuleProps) => {
38:   const [carrollData, setCarrollData] = useState<CarrollData | null>(null);
42:     loadCarrollConfig();
45:   const loadCarrollConfig = async () => {
48:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/config`,
58:         setCarrollData(result.config);
64:       console.error('[Carroll] Error al cargar configuraci√≥n:', error);
72:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/eta-params`,
86:         loadCarrollConfig();
91:       console.error('[Carroll] Error al guardar par√°metros:', error);
114:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/upload`,
127:         loadCarrollConfig();
132:       console.error('[Carroll] Error al subir KML:', error);
155:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/upload`,
168:         loadCarrollConfig();
173:       console.error('[Carroll] Error al subir clientes:', error);
204:       title="Configuraci√≥n Carroll - Granjas Carroll" 
423:               {carrollData?.rutas && carrollData.rutas.length > 0 && (
426:                     ‚úÖ {carrollData.rutas.length} rutas cargadas
466:               {carrollData?.clientes && carrollData.clientes.length > 0 && (
469:                     ‚úÖ {carrollData.clientes.length} clientes cargados

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
2: import { ModuleTemplate } from './ModuleTemplate';
203:     <ModuleTemplate 
494:     </ModuleTemplate>


==================== CarrollModule.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
4: interface CarrollModuleProps {
57: export const DedicadosModule = ({ onBack }: CarrollModuleProps) => {
85:     a.download = `carroll-${vistaActiva}-${new Date().toISOString().split('T')[0]}.csv`;
90:     alert(`Descargando: ${tipo.toUpperCase()}_Carroll_2024.pdf`);
177:                   CARROLL
180:                   Granjas Carroll ‚Ä¢ Oriental, Puebla


==================== CarrollModuleFinal.tsx ====================
-- pattern: functions\/v1
814:                 const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/widetech/wsdl`, {
838:                 const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/widetech/mobile-list`, {
869:                 const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/widetech/megatest`, {

-- pattern: WIDETECH|WideTech|widetech
814:                 const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/widetech/wsdl`, {
821:                 (window as any).widetechWSDL = data;
822:                 alert(`üìã M√âTODOS WIDETECH DISPONIBLES:\n\n${data.metodos.join('\n')}\n\n‚úÖ Total: ${data.totalMetodos} m√©todos\n\nRevisa la consola (F12) para ver detalles.`);
838:                 const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/widetech/mobile-list`, {
845:                 (window as any).widetechMobileList = data;
848:                   alert(`üì± M√ìVILES REGISTRADOS EN WIDETECH:\n\nTotal: ${data.total} m√≥viles\n\nRevisa la consola (F12) para ver la lista completa con nombres y placas.`);
869:                 const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/widetech/megatest`, {
875:                 (window as any).widetechMegatest = data;

-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
205:     const interval = setInterval(() => {

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
11: interface CarrollModuleProps {
50: // üöö 28 UNIDADES DEDICADAS GRANJAS CARROLL - DATOS REALES ACTUALIZADOS
104: export const DedicadosModule = ({ onBack }: CarrollModuleProps) => {
112:         const { data } = await supabaseGPS.from('gps_tracking').select('economico, latitude, longitude, speed, timestamp_gps, address, status').eq('segmento', 'CARROLL');
120:     const channel = supabaseGPS.channel('carroll_gps_rt').on('postgres_changes', { event: '*', schema: 'public', table: 'gps_tracking', filter: 'segmento=eq.CARROLL' }, () => cargarGPS()).subscribe();
151:   // ‚úÖ FUNCI√ìN GPS - LEE DE SUPABASE gps_tracking (segmento=CARROLL)
154:     console.log('üõ∞Ô∏è [GPS] Obteniendo ubicaciones desde Supabase gps_tracking (CARROLL)...');
157:       // Leer TODAS las unidades de CARROLL desde gps_tracking
159:         `https://${projectId}.supabase.co/rest/v1/gps_tracking?segmento=eq.CARROLL&select=economico,latitude,longitude,speed,address,timestamp_gps,status`,
169:       console.log(`üõ∞Ô∏è [GPS] Supabase response (${Array.isArray(data) ? data.length : 0} unidades CARROLL):`, data);
192:         console.log(`‚úÖ [GPS] Total ubicaciones CARROLL cargadas: ${Object.keys(locations).length}`);
227:                   Carroll ‚Ä¢ 30 Unidades Activas
249:                     zoomControl: true,
250:                     streetViewControl: false,
251:                     mapTypeControl: false,
252:                     fullscreenControl: true,
673:                 <h1 style={{ fontFamily: "'Exo 2', sans-serif", fontSize: '18px', fontWeight: 900, lineHeight: '1' }}>CARROLL</h1>
674:                 <p className="text-slate-500" style={{ fontSize: '11px' }}>Granjas Carroll ‚Ä¢ Oriental, Puebla</p>

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
7: const SUPABASE_URL_GPS = 'https://fbxbsslhewchyibdoyzk.supabase.co';
8: const SUPABASE_ANON_KEY_GPS = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieGJzc2xoZXdjaHlpYmRveXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzczODEsImV4cCI6MjA3ODExMzM4MX0.Z8JPlg7hhKbA624QGHp2bKKTNtCD3WInQMO5twjl6a0';
9: const supabaseGPS = createClient(SUPABASE_URL_GPS, SUPABASE_ANON_KEY_GPS);
93: // Interfaz para ubicaciones GPS de Supabase
94: interface GPSLocation {
95:   placa: string;
106:   const [gpsData, setGpsData] = useState<Map<string, any>>(new Map());
107:   const [gpsLoading, setGpsLoading] = useState(true);
110:     const cargarGPS = async () => {
112:         const { data } = await supabaseGPS.from('gps_tracking').select('economico, latitude, longitude, speed, timestamp_gps, address, status').eq('segmento', 'CARROLL');
115:         setGpsData(map);
116:       } catch (e) { console.error('GPS error:', e); }
117:       setGpsLoading(false);
119:     cargarGPS();
120:     const channel = supabaseGPS.channel('carroll_gps_rt').on('postgres_changes', { event: '*', schema: 'public', table: 'gps_tracking', filter: 'segmento=eq.CARROLL' }, () => cargarGPS()).subscribe();
124:   const getUbicacionGPS = (tracto: string): string => {
125:     const gps = gpsData.get(tracto);
126:     if (!gps) return gpsLoading ? 'Cargando...' : getUbicacionGPS(unidad.tracto);
127:     if (gps.address && gps.address !== '-') return gps.address;
128:     if (gps.latitude && gps.longitude) return gps.latitude.toFixed(4) + ', ' + gps.longitude.toFixed(4);
129:     return getUbicacionGPS(unidad.tracto);
137:   const [gpsLocations, setGpsLocations] = useState<Record<string, GPSLocation>>({});
138:   const [loadingGPS, setLoadingGPS] = useState(false);
151:   // ‚úÖ FUNCI√ìN GPS - LEE DE SUPABASE gps_tracking (segmento=CARROLL)
152:   const obtenerUbicacionesGPS = async () => {
153:     setLoadingGPS(true);
154:     console.log('üõ∞Ô∏è [GPS] Obteniendo ubicaciones desde Supabase gps_tracking (CARROLL)...');
157:       // Leer TODAS las unidades de CARROLL desde gps_tracking
159:         `https://${projectId}.supabase.co/rest/v1/gps_tracking?segmento=eq.CARROLL&select=economico,latitude,longitude,speed,address,timestamp_gps,status`,
169:       console.log(`üõ∞Ô∏è [GPS] Supabase response (${Array.isArray(data) ? data.length : 0} unidades CARROLL):`, data);
172:         const locations: Record<string, GPSLocation> = {};
177:               placa: row.economico,
181:               timestamp: row.timestamp_gps || '',
186:               console.log(`‚úÖ [GPS] ${row.economico}: ${row.address}`);
191:         setGpsLocations(locations);
192:         console.log(`‚úÖ [GPS] Total ubicaciones CARROLL cargadas: ${Object.keys(locations).length}`);
195:       console.error('‚ùå [GPS] Error:', error);
197:       setLoadingGPS(false);
201:   // Auto-actualizar ubicaciones GPS cada 30 segundos
203:     obtenerUbicacionesGPS(); // Cargar al montar
206:       obtenerUbicacionesGPS();
718:             onClick={obtenerUbicacionesGPS} 
719:             disabled={loadingGPS}
723:             {loadingGPS ? (
731:                 GPS ({Object.keys(gpsLocations).length}/26)
757:                 <th className="px-3 py-1.5 text-left text-white" style={{ fontSize: '11px', fontWeight: 700 }}>üõ∞Ô∏è UBICACI√ìN GPS</th>
795:                       {gpsLocations[u.tracto] ? (
799:                             {gpsLocations[u.tracto].address || 'Ubicaci√≥n disponible'}
805:                           <div className="text-slate-500" style={{ fontSize: '11px' }}>Sin se√±al GPS</div>
837:                 setLoadingGPS(true);
848:                   alert(`üì± M√ìVILES REGISTRADOS EN WIDETECH:\n\nTotal: ${data.total} m√≥viles\n\nRevisa la consola (F12) para ver la lista completa con nombres y placas.`);
852:                 setLoadingGPS(false);
856:                 setLoadingGPS(false);
868:                 setLoadingGPS(true);
880:                   alert(`‚ö†Ô∏è Ning√∫n m√©todo devolvi√≥ datos GPS.\n\nRevisa la consola (F12) para m√°s detalles.`);
882:                 setLoadingGPS(false);
886:                 setLoadingGPS(false);
917:                 <th className="px-3 py-1.5 text-left text-white" style={{ fontSize: '11px', fontWeight: 700 }}>üõ∞Ô∏è UBICACI√ìN GPS</th>
971:                       {gpsLocations[u.tracto] ? (
974:                             {gpsLocations[u.tracto].address.substring(0, 40)}...
979:                                 const lat = gpsLocations[u.tracto].latitude;
980:                                 const lng = gpsLocations[u.tracto].longitude;
990:                               {gpsLocations[u.tracto].speed.toFixed(0)} km/h
996:                           {loadingGPS ? (
1002:                             <span className="text-slate-400" style={{ fontSize: '10px' }}>Sin datos GPS</span>


==================== CarrollModuleFinalV2.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
6: interface CarrollModuleProps {
45: // üöö 28 UNIDADES DEDICADAS GRANJAS CARROLL - DATOS REALES ACTUALIZADOS  
79: export const DedicadosModuleV2 = ({ onBack }: CarrollModuleProps) => {
123:                 DEDICADOS #12 - GRANJAS CARROLL


==================== CarrollModuleFinalV2Compact.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
6: interface CarrollModuleProps {
23: // üöö 28 UNIDADES DEDICADAS GRANJAS CARROLL - DATOS REALES ACTUALIZADOS  
55: export const CarrollModuleFinalV2Compact = ({ onBack }: CarrollModuleProps) => {
82:                 DEDICADOS #12 - GRANJAS CARROLL
323:                 Funcionalidad en desarrollo...


==================== CatalogoFormatosVenta.tsx ====================
-- pattern: functions\/v1
120:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/formatos-venta`,

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
20: // üìã CAT√ÅLOGO PERMANENTE DE FORMATOS DE VENTA GRANJAS CARROLL


==================== ConfiguracionModule.tsx ====================
-- pattern: functions\/v1
51:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/backup/download`, {
80:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/files?category=${category}`, {
105:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/files/upload`, {
130:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/files/${fileId}/download`, {
152:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/files/${fileId}`, {

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
3: import { UsuariosModule } from './UsuariosModule';
4: import { CarrollConfigModule } from './CarrollConfigModule';
27:   const [showUsuarios, setShowUsuarios] = useState(false);
29:   const [showCarroll, setShowCarroll] = useState(false);
36:   if (showUsuarios) {
37:     return <UsuariosModule onBack={() => setShowUsuarios(false)} />;
40:   if (showCarroll) {
41:     return <CarrollConfigModule onBack={() => setShowCarroll(false)} />;
293:           {/* üë• Bot√≥n USUARIOS */}
295:             onClick={() => setShowUsuarios(true)}
311:                 USUARIOS
320:                 Gestionar usuarios y permisos del sistema
396:           {/* üöö Bot√≥n CARROLL */}
398:             onClick={() => setShowCarroll(true)}
414:                 CARROLL
423:                 Configuraci√≥n de Carroll

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
2: import { ModuleTemplate } from './ModuleTemplate';
14: type FileCategory = 'cotizaciones' | 'contratos' | 'documentos' | 'imagenes' | 'otros';
31:   const [selectedCategory, setSelectedCategory] = useState<FileCategory>('cotizaciones');
51:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/backup/download`, {
173:     cotizaciones: { icon: FileText, label: 'Cotizaciones', color: 'blue' },
182:       <ModuleTemplate 
281:       </ModuleTemplate>
286:     <ModuleTemplate 
355:                 Descargar respaldo completo de leads eliminados
389:                 Gestionar cotizaciones, contratos y documentos
486:     </ModuleTemplate>


==================== ControlEquipoModule.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
4: interface ControlEquipoModuleProps {
8: export const ControlEquipoModule = ({ onBack }: ControlEquipoModuleProps) => {
10:     <ModuleTemplate title="Control de Equipo" onBack={onBack} headerImage={MODULE_IMAGES.CONTROL_EQUIPO}>
19:           Contenido del m√≥dulo Control de Equipo

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
10:     <ModuleTemplate title="Control de Equipo" onBack={onBack} headerImage={MODULE_IMAGES.CONTROL_EQUIPO}>
22:     </ModuleTemplate>


==================== CotizacionesModule.tsx ====================
-- pattern: functions\/v1
68:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/maps/distance`, {
151:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/config/tarifas`, {

-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
435:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
449:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
475:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
491:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
505:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
529:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
543:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
566:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
580:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
601:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
630:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
644:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);
658:                       setTimeout(() => calcularCostoTotal(newFormData.rutas, newFormData), 0);

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
8: interface CotizacionesModuleProps {
36: export const CotizacionesModule = ({ onBack }: CotizacionesModuleProps) => {
59:   const [cotizaciones, setCotizaciones] = useState<FormCotizacion[]>([]);
376:     setCotizaciones([...cotizaciones, {...formData}]);
397:     <ModuleTemplate title="Cotizaciones" onBack={onBack} headerImage={MODULE_IMAGES.COTIZACIONES}>
883:         {/* COTIZACIONES GUARDADAS */}
884:         {cotizaciones.length > 0 && (
888:               COTIZACIONES GUARDADAS ({cotizaciones.length})
891:               {cotizaciones.map((cot, index) => (
915:     </ModuleTemplate>


==================== DashboardCard.tsx ====================

==================== DashboardScreen.tsx ====================
-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
39:     const interval = setInterval(() => {
70:       setTimeout(() => setShowAccessDenied(false), 2000);

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
8:   userRole?: 'admin' | 'ventas' | 'operaciones';
12: export const DashboardScreen = ({ onLogout, onNavigate, userRole = 'admin', userName = 'Usuario' }: DashboardScreenProps) => {
59:     if (userRole === 'admin') return true;
60:     if (userRole === 'ventas') return moduleId !== 'configuracion';
61:     if (userRole === 'operaciones') return moduleId === 'operaciones';
75:     return ['panel-oportunidades', 'despacho-inteligente', 'control-equipo', 'servicio-clientes'].includes(moduleId);
83:     { id: 'control-equipo', name: 'Control de Equipo', icon: Wrench },
278:                 {userRole === 'admin' ? 'ADMIN' : userRole === 'ventas' ? 'VENTAS' : 'OPERACIONES'}

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
18:     const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
19:     const pastDaysOfYear = (date.getTime() - firstDayOfYear.getTime()) / 86400000;
20:     return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
51:     year: 'numeric'
86:     { id: 'cotizaciones', name: 'Cotizaciones', icon: FileText },


==================== DashboardWidgets.tsx ====================
-- pattern: functions\/v1
33:           `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/news/get-news`,

-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
62:     const interval = setInterval(() => {
121:     const interval = setInterval(() => {

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
107:         title: 'GPS en tractocamiones: Seguridad',
109:         fullDescription: 'La implementaci√≥n de sistemas GPS de √∫ltima generaci√≥n en tractocamiones ha logrado reducir los √≠ndices de robo en un 42% en las principales rutas federales. La tecnolog√≠a de rastreo satelital en tiempo real permite monitoreo continuo y respuesta inmediata ante contingencias.',


==================== DedicadosHub.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
7:   onNavigate: (module: 'admin-carroll' | 'monitor-carroll' | 'vista-clientes-carroll') => void;
112:           {/* M√ìDULO 1: ADMINISTRACI√ìN CARROLL */}
114:             onClick={() => onNavigate('admin-carroll')}
158:               ADMINISTRACI√ìN CARROLL
208:           {/* M√ìDULO 2: MONITOR CARROLL */}
210:             onClick={() => onNavigate('monitor-carroll')}
254:               MONITOR CARROLL
274:                   DESARROLLO
306:             onClick={() => onNavigate('vista-clientes-carroll')}


==================== DedicadosModule.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
49: // üöö DATOS REALES DE GRANJAS CARROLL
89: const ORIGEN_REAL = 'Granjas Carroll - Oriental, Puebla';
362:     a.download = `carroll-${vistaActiva}-${new Date().toISOString().split('T')[0]}.csv`;
405:                   CARROLL
408:                   Granjas Carroll ‚Ä¢ Oriental, Puebla


==================== DedicadosModuleWideTech.tsx ====================
-- pattern: WIDETECH|WideTech|widetech
69: export const DedicadosModuleWideTech = ({ onBack }: DedicadosModuleProps) => {

-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
76:     const timer = setInterval(() => setHoraActual(new Date()), 1000);
141:     const interval = setInterval(cargarUnidades, 30000);

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
13: interface UnidadCarroll {
30: // Datos de operadores Carroll
32:   '118': { operador: 'OPERADOR CARROLL', remolque: 'N/A', mtto: 45, origen: 'Tepeji, Hidalgo', destino: 'Granjas Carroll' },
33:   '148': { operador: 'OPERADOR CARROLL', remolque: 'N/A', mtto: 60, origen: 'Perote, Veracruz', destino: 'Granjas Carroll' },
34:   '178': { operador: 'CRISTIAN CORTEZ PORTILLO', remolque: '1376', mtto: 72, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
35:   '208': { operador: 'MARCO ANTONIO GARCIA RAMIREZ', remolque: '1282', mtto: 58, origen: 'Puebla', destino: 'Granjas Carroll' },
36:   '212': { operador: 'CHRISTIAN OJEDA VELAZQUEZ', remolque: '838843', mtto: 88, origen: 'Ciudad de Libres, Puebla', destino: 'Granjas Carroll' },
37:   '214': { operador: 'OPERADOR CARROLL', remolque: 'N/A', mtto: 35, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
38:   '433': { operador: 'OPERADOR CARROLL', remolque: 'N/A', mtto: 40, origen: 'Perote, Veracruz', destino: 'Granjas Carroll' },
39:   '505': { operador: 'RAUL BAUTISTA LOPEZ', remolque: '1292', mtto: 50, origen: 'Tepeji, Hidalgo', destino: 'Granjas Carroll' },
40:   '643': { operador: 'OPERADOR CARROLL', remolque: 'N/A', mtto: 55, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
41:   '727': { operador: 'OPERADOR CARROLL', remolque: 'N/A', mtto: 62, origen: 'Perote, Veracruz', destino: 'Granjas Carroll' },
42:   '731': { operador: 'MARIO LARA TIBURCIO', remolque: '1398', mtto: 48, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
43:   '745': { operador: 'CARLOS SERGIO FLORES VERGES', remolque: '1254', mtto: 75, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
44:   '765': { operador: 'HECTOR CHRISTIAN JAIME LEON', remolque: '838855', mtto: 72, origen: 'Ciudad Nezahualc√≥yotl, Estado de M√©xico', destino: 'Granjas Carroll' },
45:   '777': { operador: 'LUIS ANGEL TAPIA RODRIGUEZ', remolque: '1356', mtto: 65, origen: 'Tepeji, Hidalgo', destino: 'Granjas Carroll' },
47:   '801': { operador: 'FERNANDO GUZMAN SERVN', remolque: '1378', mtto: 55, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
48:   '809': { operador: 'RUMUALDO BAUTISTA GOMEZ', remolque: '28654', mtto: 68, origen: 'Tepeji, Hidalgo', destino: 'Granjas Carroll' },
49:   '813': { operador: 'EDGAR IVAN HERNANDEZ', remolque: '1360', mtto: 33, origen: 'San Antonio Virreyes, Puebla', destino: 'Granjas Carroll' },
50:   '817': { operador: 'JUAN RAMIREZ MONTES', remolque: '1278', mtto: 42, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
51:   '837': { operador: 'JOSE ALBERTO MORANCHEL VILLANUEVA', remolque: '1296', mtto: 40, origen: 'San Antonio Virreyes, Puebla', destino: 'Granjas Carroll' },
52:   '841': { operador: 'RENE ALONSO VAZQUEZ CRUZ', remolque: '1262', mtto: 58, origen: 'Perote, Veracruz', destino: 'Granjas Carroll' },
53:   '847': { operador: 'VICTOR FRANCO MONTA√ëO', remolque: '1396', mtto: 70, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
54:   '859': { operador: 'HECTOR ADRIAN LOPEZ MEDINA', remolque: '1414', mtto: 45, origen: 'Tepeji, Hidalgo', destino: 'Granjas Carroll' },
55:   '861': { operador: 'JUAN FRANCISCO LEOS FRAGOSO', remolque: '1208', mtto: 52, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
56:   '863': { operador: 'OCTAVIO VILLELA TRENADO', remolque: '4113', mtto: 38, origen: 'Perote, Veracruz', destino: 'Granjas Carroll' },
57:   '879': { operador: 'OPERADOR CARROLL', remolque: 'N/A', mtto: 30, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
58:   '891': { operador: 'FEDERICO CLEMENTE QUINTERO', remolque: '1350', mtto: 65, origen: 'Tepeji, Hidalgo', destino: 'Granjas Carroll' },
59:   '893': { operador: 'MARCELO SANCHEZ RODRIGUEZ', remolque: '1406', mtto: 20, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
60:   '899': { operador: 'JULIO ENRIQUE ARELLANO PEREZ', remolque: '1332', mtto: 50, origen: 'Parque Industrial Tepeji, Hidalgo', destino: 'Granjas Carroll' },
61:   '905': { operador: 'JUAN ALAN DIAZ MARTINEZ', remolque: '1260', mtto: 48, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
62:   '911': { operador: 'ENRIQUE URBAN FLORES', remolque: '1256', mtto: 55, origen: 'Perote, Veracruz', destino: 'Granjas Carroll' },
63:   '931': { operador: 'MARCELO SANCHEZ RODRIGUEZ', remolque: '1288', mtto: 62, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
64:   '933': { operador: 'JUAN MANUEL OJEDA VELAZQUEZ', remolque: '1328', mtto: 20, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
65:   '937': { operador: 'VICTOR ISLAS ORIA', remolque: '1348', mtto: 75, origen: 'Tepeji, Hidalgo', destino: 'Granjas Carroll' },
66:   '945': { operador: 'OPERADOR CARROLL', remolque: 'N/A', mtto: 42, origen: 'Oriental, Puebla', destino: 'Granjas Carroll' },
70:   const [unidades, setUnidades] = useState<UnidadCarroll[]>([]);
85:         .or('segmento.eq.CARROL,segmento.eq.CARROLL');
90:         const mapped: UnidadCarroll[] = data.map((r: any) => {
92:             operador: 'OPERADOR CARROLL', 
96:             destino: 'Granjas Carroll' 
137:       .channel('carroll_changes')
146:   const tieneGPS = (u: UnidadCarroll) => u.latitude !== null && u.latitude !== 0;
178:           <div className="text-white text-lg">Cargando GPS Carroll...</div>
194:               OPERATIONS HUB ¬∑ GRANJAS CARROLL

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
20:   timestamp_gps: string | null;
83:         .from('gps_tracking')
106:             timestamp_gps: r.timestamp_gps,
138:       .on('postgres_changes', { event: '*', schema: 'public', table: 'gps_tracking' }, () => cargarUnidades())
146:   const tieneGPS = (u: UnidadCarroll) => u.latitude !== null && u.latitude !== 0;
150:     conGPS: unidades.filter(tieneGPS).length,
151:     enMovimiento: unidades.filter(u => tieneGPS(u) && u.status === 'moving').length,
152:     detenidos: unidades.filter(u => tieneGPS(u) && u.status === 'stopped').length,
153:     sinSenal: unidades.filter(u => !tieneGPS(u)).length,
178:           <div className="text-white text-lg">Cargando GPS Carroll...</div>
206:               <span style={{ color: '#10B981', fontSize: '13px', fontWeight: 700 }}>{stats.conGPS}/{stats.total}</span>
259:             <div>Ubicaci√≥n GPS</div>
271:               const gpsOK = tieneGPS(u);
295:                   {/* UBICACI√ìN GPS */}
297:                     {gpsOK ? (
308:                             Live GPS
316:                         Sin se√±al GPS
323:                     {gpsOK ? (
335:                         Sin GPS
342:                     {gpsOK ? (
373:                     {formatTime(u.timestamp_gps)}


==================== DespachoInteligenteContent.tsx ====================
-- pattern: supabase\.from\(
77:       const { data, error } = await supabase.from('gps_tracking').select('*').order('segmento');

-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
103:     const countdownInterval = setInterval(calcularProximoCron, 1000);
106:     const dataInterval = setInterval(loadData, 15000);

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
12: const SEGMENTOS = ['IMPEX', 'CARROL', 'BAFAR', 'NatureSweet', 'Pilgrims', 'ALPURA', 'BARCEL', 'PATIOS', 'ACCIDENTE', 'PENDIENTE'];

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
22:   timestamp_gps: string | null;
77:       const { data, error } = await supabase.from('gps_tracking').select('*').order('segmento');
96:     const channel = supabase.channel('gps_realtime')
97:       .on('postgres_changes', { event: '*', schema: 'public', table: 'gps_tracking' }, () => {
121:     if (statusF === 'no_signal' && !['no_signal', 'gps_issue', 'pending'].includes(u.status)) return false;
129:     sin: segmentoUnits.filter(u => ['no_signal', 'gps_issue', 'pending'].includes(u.status)).length,
142:     filtered.forEach(u => rows.push([u.economico, u.empresa, u.segmento, u.status, u.stopped_time || '', String(u.speed || 0), u.address || '', String(u.latitude || ''), String(u.longitude || ''), u.timestamp_gps || '']));
146:     link.download = `GPS_${activeSegmento}_${new Date().toISOString().slice(0, 10)}.csv`;
170:       case 'gps_issue': return 'bg-purple-500/20 text-purple-400';
191:           <p className="text-slate-300 text-lg mb-4">No hay datos GPS disponibles</p>
326:                     <td className="px-3 py-1.5 text-slate-400 text-[10px]">{formatTime(u.timestamp_gps)}</td>


==================== DespachoInteligenteModule.tsx ====================
-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
11:     <ModuleTemplate title="Despacho Inteligente" onBack={onBack} headerImage={MODULE_IMAGES.DESPACHO_INTELIGENTE}>
13:     </ModuleTemplate>


==================== EjemploUbicacionesInteligentes.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
12:       nombre: 'Granjas Carroll (origen)',
15:       descripcion: 'Debe detectarse como "Granjas Carroll" (radio 500m)'
77:                 üè≠ Granjas Carroll: 500m
185:               <strong className="text-white">1. Granjas Carroll (Origen):</strong> Radio de 500 metros. Se detecta con prioridad m√°xima.

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
218:   lat={unidad.lat}  // Del GPS de la unidad


==================== EjemploUbicacionGPS.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
9:  * 1. Detecci√≥n autom√°tica de Granjas Carroll (radio 500m)
29:     lat: 19.3419, // EXACTAMENTE en Granjas Carroll
37:     lat: 19.3425, // A 100m de Granjas Carroll
72:             Detecci√≥n autom√°tica de Granjas Carroll + Reverse Geocoding con Google Maps
85:                 üéØ GEOCERCA GRANJAS CARROLL
92:                 <strong className="text-emerald-400">"üè≠ Granjas Carroll, Oriental Puebla"</strong>
218:   estaEnGranjasCarroll, 
223: // Verificar si est√° en Granjas Carroll
224: const enGranjas = estaEnGranjasCarroll({ lat: 19.3419, lng: -97.6664 });
239:             ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Este sistema usa Google Maps Geocoding API. Aseg√∫rate de tener habilitada la API en tu proyecto de Google Cloud y que tu API Key tenga los permisos necesarios.

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
59: export const EjemploUbicacionGPS = () => {
121:                     COORDENADAS GPS


==================== FormatosVentaHub.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
34:               FORMATOS DE VENTA - GRANJAS CARROLL


==================== Input.tsx ====================

==================== KPIsModule.tsx ====================
-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
10:     <ModuleTemplate title="KPIs" onBack={onBack} headerImage={MODULE_IMAGES.KPIS}>
22:     </ModuleTemplate>


==================== LoginScreen.tsx ====================

==================== MapaClim aticoCarroll.tsx ====================
-- pattern: functions\/v1
88:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/api-keys/google-maps`,

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
5: interface MapaClimaticoCarrollProps {
15: // Tipos de capas meteorol√≥gicas disponibles
32: export const MapaClimaticoCarroll = ({ onClose, unidades = [] }: MapaClimaticoCarrollProps) => {
144:       // Centro del mapa: Granjas Carroll
193:   // Cambiar capa meteorol√≥gica
267:               MAPA CLIM√ÅTICO - CARROLL
270:               Monitoreo meteorol√≥gico en tiempo real
290:             üå¶Ô∏è CAPAS METEOROL√ìGICAS
347:               <strong className="text-white">Actualizaci√≥n:</strong> Cada 10 minutos desde estaciones meteorol√≥gicas globales.


==================== MapaClimaticoCarroll.tsx ====================
-- pattern: functions\/v1
89:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/api-keys/google-maps`,
212:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/api-keys/openweather`,

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
5: interface MapaClimaticoCarrollProps {
15: // Tipos de capas meteorol√≥gicas disponibles
32: export const MapaClimaticoCarroll = ({ onClose, unidades = [] }: MapaClimaticoCarrollProps) => {
145:       // Centro del mapa: Granjas Carroll
194:   // Cambiar capa meteorol√≥gica
261:       console.error('Error configurando capa meteorol√≥gica:', error);
262:       alert('‚ö†Ô∏è Error al cargar la capa meteorol√≥gica. Ver consola para detalles.');
297:               MAPA CLIM√ÅTICO - CARROLL
300:               Monitoreo meteorol√≥gico en tiempo real
320:             üå¶Ô∏è CAPAS METEOROL√ìGICAS
377:               <strong className="text-white">Actualizaci√≥n:</strong> Cada 10 minutos desde estaciones meteorol√≥gicas globales.


==================== MapaFlota.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
100:           {/* CONTROLES DE ZOOM */}

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
5:   placa: string;
18:   onSeleccionarUnidad: (placa: string) => void;
54:       const ubicacion = ubicaciones.find(u => u.placa === unidadSeleccionada);
95:             Rep√∫blica Mexicana ‚Ä¢ GPS en tiempo real
214:             const esSeleccionada = unidadSeleccionada === ubicacion.placa;
219:                 key={ubicacion.placa}
233:                   onClick={() => onSeleccionarUnidad(ubicacion.placa)}
275:                       {ubicacion.placa}
306:                             {ubicacion.placa}
402:             const esSeleccionada = unidadSeleccionada === ubicacion.placa;
406:                 key={ubicacion.placa}
407:                 onClick={() => onSeleccionarUnidad(ubicacion.placa)}
424:                 {ubicacion.placa}


==================== MapaFlotaGoogleMaps.tsx ====================
-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
291:     hoverTimeoutRef.current = setTimeout(() => {

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
228:       { nombre: 'GRANJAS CARROLL', ciudad: 'Oriental', estado: 'Puebla' },
367:                 MAPA DE FLOTA GRANJAS CARROLL
556:                     zoomControl: true,
557:                     streetViewControl: false,
558:                     fullscreenControl: true,

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
7:   placa: string;
23:   onSeleccionarUnidad: (placa: string) => void;
79:         const ubicacion = ubicaciones.find(u => u.placa === unidadSeleccionada);
109:   const getMarkerIcon = (placa: string, unidadesEnCluster: number = 1, isSelected: boolean = false) => {
146:               dominant-baseline="middle">${placa}</text>
180:       if (procesadas.has(ubicacion.placa)) return;
189:         if (otra.placa === ubicacion.placa || procesadas.has(otra.placa)) return;
198:           procesadas.add(otra.placa);
202:       procesadas.add(ubicacion.placa);
378:                 {ubicaciones.length} unidades con GPS activo
432:                         key={unidad.placa}
436:                           onSeleccionarUnidad(unidad.placa);
450:                             {unidad.placa}
562:                     const isSelected = selectedMarker === cluster.unidades[0].placa;
564:                     const markerIcon = getMarkerIcon(cluster.unidades[0].placa, cluster.unidades.length, isSelected);
568:                         key={cluster.unidades[0].placa}
574:                             setSelectedMarker(cluster.unidades[0].placa);
575:                             onSeleccionarUnidad(cluster.unidades[0].placa);
585:                             zIndex: isSelected ? 1000 : cluster.unidades[0].placa.charCodeAt(0)
587:                           title={`Unidad ${cluster.unidades[0].placa}`}
591:                             alt={`Unidad ${cluster.unidades[0].placa}`}
602:                   {selectedMarker && ubicaciones.find(u => u.placa === selectedMarker) && (() => {
603:                     const ubicacionSeleccionada = ubicaciones.find(u => u.placa === selectedMarker)!;
703:                   const isSelected = unidadSeleccionada === ubicacion.placa;
709:                       key={ubicacion.placa}
710:                       onClick={() => onSeleccionarUnidad(ubicacion.placa)}
728:                             {ubicacion.placa}


==================== ModuleTemplate.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
106:       {/* Barra superior PREMIUM - Gradiente navy/petroleo + noise */}
114:         {/* Base: Gradiente oscuro navy -> petroleo */}

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
4: interface ModuleTemplateProps {
11: export const ModuleTemplate = ({ title, onBack, children, headerImage }: ModuleTemplateProps) => {


==================== NewsTicker.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
125:             className="flex gap-12 animate-scroll"
129:               animation: indicePausa !== null ? 'none' : 'scroll 60s linear infinite'
152:         @keyframes scroll {
160:         .animate-scroll {
161:           animation: scroll 60s linear infinite;


==================== NuevoFormatoVenta.tsx ====================
-- pattern: functions\/v1
30:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/formatos-venta`,

-- pattern: setInterval|setTimeout|visibilitychange|document\.hidden
57:         setTimeout(() => {

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
386:                   üè≠ Granjas Carroll Oriental


==================== PanelOportunidadesModule.tsx ====================
-- pattern: functions\/v1
127:     const response = await fetch(`https://fbxbsslhewchyibdoyzk.supabase.co/functions/v1/analizar-cotizacion-pdf`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${publicAnonKey}` }, body: JSON.stringify({ imagenBase64, textoPDF }) });
312:         const url = `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`;
430:             await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, {
579:       await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) });
586:   const handleEliminarCotizacion = async (lead: Lead, index: number) => { const cotizaciones = lead.cotizaciones?.map((c, i) => i === index ? { ...c, eliminado: true } : c) || []; const potencialTotal = cotizaciones.filter(c => !c.eliminado && c.potencialMXN).reduce((sum, c) => sum + (c.potencialMXN || 0), 0); const leadActualizado = { ...lead, cotizaciones, proyectadoVentaMensual: potencialTotal > 0 ? `$${potencialTotal.toLocaleString('es-MX')} MXN` : '', fechaActualizacion: new Date().toISOString() }; try { await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === lead.id ? leadActualizado : l)); setCotizacionesModal(leadActualizado); } catch { alert('Error'); } };
587:   const handleConfirmarEliminacion = async () => { if (!deleteModal || deleteConfirmText !== 'DELETE') return; try { const leadActualizado = { ...deleteModal, eliminado: true, fechaEliminado: new Date().toISOString() }; await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${deleteModal.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === deleteModal.id ? leadActualizado : l)); setDeleteModal(null); setDeleteConfirmText(''); } catch { alert('Error'); } };
588:   const handleRestaurarLead = async (lead: Lead) => { if (!isAdmin) return; try { const leadActualizado = { ...lead, eliminado: false, fechaEliminado: null }; await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === lead.id ? leadActualizado : l)); } catch {} };
632:       await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${editLead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) });

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
11: // üìã PERMISOS OPORTUNIDADES - userVendedorLeads viene desde App.tsx
39: const CLIENTES_EXISTENTES = ['ABASTECEDORA DE MATERIAS PRIMAS','AGROINDUSTRIAL AGRILEG DE TEHUACAN','AGROPECUARIA MARLEE','AGROS','ALIANZA CARNICA','ALIMENTOS FINOS DE OCCIDENTE','ALIMENTOS Y SAZONADORES REGIOS','ALL CARRIERS, INC.','ARCBEST II INC','ARCH MEAT','ATLAS EXPEDITORS','AVICOLA PILGRIM\'S PRIDE DE MEXICO','BAKERY MACHINERY AND ENGINEERING LLC','BARCEL','BARRY CALLEBAUT MEXICO','BBA LOGISTCS LLC','BERRIES PARADISE','BIMBO','BISON TRANSPORT INC','C H ROBINSON DE MEXICO','CADENA COMERCIAL OXXO','CARNES SELECTAS TANGAMANGA','CAROLINA LOGISTICS INC','CFI LOGISTICA','CH ROBINSON WORLDWIDE, INC','COMERCIALIZADORA DE LACTEOS Y DERIVADOS','COMERCIALIZADORA GAB','COMERCIALIZADORA KEES','DEACERO','DISTRIBUCION Y EMBARQUES FRESH','EA LOGISTICA','EMPACADORA DE CARNES UNIDAD GANADERA','ENLACES TERRESTRES DEL BOSQUE','FRIGORIFICO Y EMPACADORA DE AGUASCALIENTES','FWD LOGISTICA','GANADEROS PRODUCTORES DE LECHE PURA','GRANJAS CARROLL DE MEXICO','GRANJERO FELIZ','GRUPO MELANGE DE MEXICO','HEXPOL COMPOUNDING','HIGH TECH FARMS','HONDA TRADING DE MEXICO','HORTIFRUT','IMPORTADORA DE PRODUCTOS CARNICOS APODACA','INDUSTRIALIZADORA DE CARNICOS STRATTEGA','INDUSTRIAS ACROS WHIRLPOOL','INTERCARNES','INTERLAND TRANSPORT','INTERLAND USA','JOHNSON CONTROLS ENTERPRISES MEXICO','KGL INTERNATIONAL NETWORK MEXICO','KONEKT INTERSERVICE','KRONUS LOGISTICS LLC','LOGISTEED MEXICO','LONGHORN WAREHOUSES, INC','MAR BRAN','MARBRAN USA, LTD','MARTICO MEX','MCALLEN MEAT PURVEYORS, LLC','MCCAIN MEXICO','NATURESWEET COMERCIALIZADORA','NATURESWEET INVERNADEROS','NS BRANDS, LTD','NUVOCARGO','ONE SOLUTION GROUP, INC','P.A.C. INTERNATIONAL','PERFORMER LOGISTICS','PILGRIM\'S PRIDE','PIPER TRADING LLC','POLLO Y HUEVO TRIUNFO','PRODUCTORA AGRICOLA DE AGUASCALIENTES','PRODUCTORA DE BOCADOS CARNICOS','PRODUCTOS CAREY','PRODUCTOS FRUGO','PROMOTORA DE MERCADOS','R.H. SHIPPING & CHARTERING','RANCHO ACUICOLA ELIXIR','RED ROAD LOGISTICS INC','SCHENKER INTERNATIONAL','SERVI CARNES DE OCCIDENTE','SIGMA ALIMENTOS CENTRO','SIGMA ALIMENTOS COMERCIAL','SPEEDYHAUL INTERNATIONAL','STEERINGMEX','SUMMIT PLASTICS GUANAJUATO','SUN CHEMICAL','TEU LOGISTICA','TITAN MEATS LLC','TRANSPLACE MEXICO LLC','TRAXION TECHNOLOGIES','TROB TRANSPORTES','TROB USA, LLC','UNITED FC DE MEXICO','VALLE REDONDO','VDT LOGISTICA','VEGGIE PRIME','VICTUX','VISCERAS SELECTAS DEL BAJIO','WEXPRESS','WHIRLPOOL INTERNACIONAL','ZEBRA LOGISTICS','ZEBRA LOGISTICS, INC'];
295:           const usuarios = JSON.parse(localStorage.getItem('fx27-usuarios') || '[]'); 
296:           const usuario = usuarios.find((u: any) => u.correo === email); 
299:             esAdmin = usuario.rol === 'admin'; 
300:             esCsr = usuario.rol === 'csr';
456:     // Filtrar seg√∫n permisos
1044:           {/* BODY TABLA - Con scrollbar estilizado y scrollbar-gutter */}
1048:               scrollbarWidth: 'thin',
1049:               scrollbarColor: 'rgba(100,116,139,0.4) transparent',
1050:               scrollbarGutter: 'stable'
1054:               .table-scroll::-webkit-scrollbar { width: 6px; }
1055:               .table-scroll::-webkit-scrollbar-track { background: transparent; }
1056:               .table-scroll::-webkit-scrollbar-thumb { background: rgba(100,116,139,0.4); border-radius: 3px; }
1057:               .table-scroll::-webkit-scrollbar-thumb:hover { background: rgba(100,116,139,0.6); }

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
11: // üìã PERMISOS OPORTUNIDADES - userVendedorLeads viene desde App.tsx
13: // | Usuario            | userVendedorLeads | Leads que ve                    |
19: // | Isis Estrada       | 'Isis Estrada'    | Solo leads donde vendedor match  |
20: // | Paloma Oliva       | 'Paloma Oliva'    | Solo leads donde vendedor match  |
26:   userVendedorLeads?: string; // 'Isis Estrada' | 'Paloma Oliva' | '' (admin/csr ve todo)
32: interface Lead { id: string; nombreEmpresa: string; paginaWeb: string; nombreContacto: string; telefonoContacto?: string; correoElectronico: string; tipoServicio: string[]; tipoViaje: string[]; principalesRutas: string; viajesPorMes: string; tarifa: string; proyectadoVentaMensual?: string; proximosPasos: string; etapaLead?: string; altaCliente?: boolean; generacionSOP?: boolean; juntaArranque?: boolean; facturado?: boolean; vendedor: string; fechaCaptura?: string; fechaActualizacion?: string; cotizaciones?: Cotizacion[]; eliminado?: boolean; fechaEliminado?: string; historial?: HistorialCambio[]; fechaLiberacion?: string; holdInfo?: HoldInfo; declinado?: boolean; fechaDeclinado?: string; }
33: type SortField = 'nombreEmpresa' | 'vendedor' | 'fechaCaptura' | 'viajesPorMes';
36: // Estatus disponibles para leads
41: const formatDate = (dateStr: string | undefined): string => { if (!dateStr) return '-'; try { const date = new Date(dateStr); if (isNaN(date.getTime())) return '-'; return date.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch { return '-'; } };
42: const formatDateTime = (dateStr: string | undefined): string => { if (!dateStr) return '-'; try { const date = new Date(dateStr); if (isNaN(date.getTime())) return '-'; return date.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch { return '-'; } };
159: const calcularPotencialDesdeCotizaciones = (lead: Lead): number => {
160:   if (!lead.cotizaciones) return 0;
161:   return lead.cotizaciones.filter(c => !c.eliminado && c.potencialMXN).reduce((sum, c) => sum + (c.potencialMXN || 0), 0);
165: // Detecta: cliente existente, lead de otro vendedor, lead propio, similares
168:   esLeadOtroVendedor: boolean;
169:   vendedorActual: string;
172:   similares: { nombre: string; tipo: 'cliente' | 'lead'; vendedor?: string }[];
177:   todosLosLeads: Lead[], 
178:   vendedorActual: string
185:   // 2. Verificar si es lead de otro vendedor
186:   const leadOtroVendedor = todosLosLeads.find(l => 
188:     l.vendedor !== vendedorActual &&
193:   const leadPropio = todosLosLeads.find(l => 
195:     l.vendedor === vendedorActual &&
200:   const similares: { nombre: string; tipo: 'cliente' | 'lead'; vendedor?: string }[] = [];
211:   // Similares en leads (de cualquier vendedor)
212:   todosLosLeads.forEach(l => { 
219:           vendedor: l.vendedor 
227:     esLeadOtroVendedor: !!leadOtroVendedor,
228:     vendedorActual: leadOtroVendedor?.vendedor || '',
230:     duplicadoExacto: esClienteExistente || !!leadOtroVendedor || !!leadPropio,
236: const buscarDuplicados = (nombre: string, leadsExistentes: Lead[]): { duplicadoExacto: boolean; similares: string[] } => {
238:   const duplicadoExacto = CLIENTES_EXISTENTES.some(c => c.toUpperCase() === nombreNorm) || leadsExistentes.some(l => l.nombreEmpresa.toUpperCase() === nombreNorm);
242:   leadsExistentes.forEach(l => { const lNorm = l.nombreEmpresa.toUpperCase(); if (lNorm !== nombreNorm && palabras.some(p => lNorm.includes(p)) && !similares.includes(l.nombreEmpresa)) similares.push(l.nombreEmpresa); });
255: export const PanelOportunidadesModule = ({ onBack, userVendedorLeads }: PanelOportunidadesModuleProps) => {
256:   const [leads, setLeads] = useState<Lead[]>([]);
257:   const [allLeads, setAllLeads] = useState<Lead[]>([]); // TODOS los leads para validaci√≥n de duplicados
258:   const [filteredLeads, setFilteredLeads] = useState<Lead[]>([]);
261:   const [filterVendedor, setFilterVendedor] = useState('');
263:   const [funnelVendedor, setFunnelVendedor] = useState(''); // Filtro de vendedor para Funnel
264:   const [vendedorActual, setVendedorActual] = useState(''); // Nombre del vendedor logueado
269:   const [cotizacionesModal, setCotizacionesModal] = useState<Lead | null>(null);
288:     const cargarLeads = async () => {
292:         let vendedor = '', esAdmin = false, esCsr = false;
298:             vendedor = usuario.nombre; 
303:             setVendedorActual(vendedor);
307:         console.log('üìã Cargando leads...');
308:         console.log('   ‚Üí userVendedorLeads:', userVendedorLeads || 'VER TODO');
311:         // Siempre cargar todos los leads
312:         const url = `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads`;
317:           let leadsData = result.leads || [];
318:           console.log('   ‚Üí Total leads en BD:', leadsData.length);
320:           // Si userVendedorLeads tiene valor, filtrar por nombre de vendedor
321:           if (userVendedorLeads && userVendedorLeads.trim() !== '') {
322:             console.log('üîí Filtrando leads para:', userVendedorLeads);
323:             leadsData = leadsData.filter((l: Lead) => {
324:               const vendedorLead = (l.vendedor || '').toLowerCase().trim();
325:               const filtro = userVendedorLeads.toLowerCase().trim();
326:               // Comparar si el vendedor del lead contiene o es igual al filtro
327:               return vendedorLead === filtro || vendedorLead.includes(filtro);
329:             console.log('   ‚Üí Leads filtrados:', leadsData.length);
332:           // Si no tiene userVendedorLeads y no es admin/csr, filtrar por su nombre
333:           else if (!esAdmin && !esCsr && vendedor) {
334:             console.log('üîí Filtrando por nombre de usuario:', vendedor);
335:             leadsData = leadsData.filter((l: Lead) => 
336:               (l.vendedor || '').toLowerCase().trim() === vendedor.toLowerCase().trim()
338:             console.log('   ‚Üí Leads filtrados:', leadsData.length);
341:           // Guardar todos los leads para validaci√≥n de duplicados
342:           setAllLeads(result.leads || []);
344:           // Guardar leads filtrados
345:           setLeads(leadsData); 
346:           setFilteredLeads(leadsData.filter((l: Lead) => !l.eliminado)); 
350:         console.error('‚ùå Error cargando leads:', error); 
355:     cargarLeads();
356:   }, [userVendedorLeads]);
359:   const detectarDuplicadosExistentes = (leadsArray: Lead[]): Map<string, Lead[]> => {
363:     // Agrupar leads por nombre normalizado
364:     leadsArray.filter(l => !l.eliminado && !l.declinado).forEach(lead => {
373:     nombresCounts.forEach((leads, nombre) => {
374:       if (leads.length > 1) {
375:         duplicados.set(nombre, leads);
383:   const esLeadDuplicado = (lead: Lead): { esDuplicado: boolean; cantidad: number; otrosVendedores: string[] } => {
385:     const duplicados = allLeads.filter(l => 
392:     const otrosVendedores = [...new Set(duplicados.map(l => l.vendedor).filter(v => v !== lead.vendedor))];
397:       otrosVendedores
401:   // Funci√≥n para verificar y reactivar leads en Hold que cumplieron 30 d√≠as
402:   const verificarHoldsExpirados = async (leadsArray: Lead[]): Promise<Lead[]> => {
404:     const leadsActualizados: Lead[] = [];
406:     for (const lead of leadsArray) {
426:           leadsActualizados.push(leadReactivado);
430:             await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, {
440:     return leadsActualizados;
444:     let resultado = [...leads];
449:         setLeads(prevLeads => prevLeads.map(l => {
471:     if (filterVendedor) resultado = resultado.filter(lead => lead.vendedor === filterVendedor);
474:     setFilteredLeads(resultado);
475:   }, [leads, searchTerm, filterVendedor, filterFecha, sortField, sortDirection, showDeleted, isAdmin]);
488:   const handleExportExcel = () => { const headers = ['Empresa', 'Contacto', 'Email', 'Servicio', 'Viaje', 'Rutas', 'Viajes/Mes', 'Potencial MXN', 'Vendedor', 'Fecha']; const rows = filteredLeads.map(lead => { const potencial = calcularPotencialDesdeCotizaciones(lead); return [lead.nombreEmpresa, lead.nombreContacto, lead.correoElectronico, (lead.tipoServicio||[]).join(', '), (lead.tipoViaje||[]).join(', '), lead.principalesRutas, lead.viajesPorMes, potencial > 0 ? `$${potencial.toLocaleString('es-MX')}` : '', lead.vendedor, formatDate(lead.fechaCaptura)]; }); const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `leads_fx27_${new Date().toISOString().split('T')[0]}.csv`; link.click(); };
489:   const getVendedoresUnicos = () => Array.from(new Set(leads.map(lead => lead.vendedor)));
491:   const handleSubirCotizaciones = async (files: FileList, lead: Lead) => {
508:         const leadTemp = { ...lead, cotizaciones: [...(lead.cotizaciones || []), nuevaCot] };
509:         setLeads(leads.map(l => l.id === lead.id ? leadTemp : l));
510:         setCotizacionesModal(leadTemp);
512:         setLineasModal({ cotizacion: nuevaCot, lead: leadTemp, index: (lead.cotizaciones || []).length });
566:     const cotizaciones = [...(lead.cotizaciones || [])];
571:     cotizaciones[index] = { ...cotizaciones[index], lineas: lineasConSubtotal, potencialMXN };
575:     let potencialTotal = 0; cotizaciones.forEach(cot => { if (!cot.eliminado && cot.potencialMXN) potencialTotal += cot.potencialMXN; });
576:     const historialNuevo: HistorialCambio = { fecha: new Date().toISOString(), campo: 'cotizaciones', valorAnterior: '', valorNuevo: `Nueva cotizacion: ${cotizaciones[index].nombre}`, usuario: lead.vendedor };
577:     const leadActualizado = { ...lead, cotizaciones, tipoViaje: tiposViaje, tipoServicio: tiposServicio, principalesRutas: rutas, viajesPorMes: String(totalViajes), proyectadoVentaMensual: potencialTotal > 0 ? `$${potencialTotal.toLocaleString('es-MX')} MXN` : '', etapaLead: 'Cotizado', fechaActualizacion: new Date().toISOString(), historial: [...(lead.historial || []), historialNuevo] };
579:       await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) });
580:       setLeads(leads.map(l => l.id === lead.id ? leadActualizado : l));
581:       setCotizacionesModal(leadActualizado); setLineasModal(null); setLineasCotizacion([]);
586:   const handleEliminarCotizacion = async (lead: Lead, index: number) => { const cotizaciones = lead.cotizaciones?.map((c, i) => i === index ? { ...c, eliminado: true } : c) || []; const potencialTotal = cotizaciones.filter(c => !c.eliminado && c.potencialMXN).reduce((sum, c) => sum + (c.potencialMXN || 0), 0); const leadActualizado = { ...lead, cotizaciones, proyectadoVentaMensual: potencialTotal > 0 ? `$${potencialTotal.toLocaleString('es-MX')} MXN` : '', fechaActualizacion: new Date().toISOString() }; try { await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === lead.id ? leadActualizado : l)); setCotizacionesModal(leadActualizado); } catch { alert('Error'); } };
587:   const handleConfirmarEliminacion = async () => { if (!deleteModal || deleteConfirmText !== 'DELETE') return; try { const leadActualizado = { ...deleteModal, eliminado: true, fechaEliminado: new Date().toISOString() }; await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${deleteModal.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === deleteModal.id ? leadActualizado : l)); setDeleteModal(null); setDeleteConfirmText(''); } catch { alert('Error'); } };
588:   const handleRestaurarLead = async (lead: Lead) => { if (!isAdmin) return; try { const leadActualizado = { ...lead, eliminado: false, fechaEliminado: null }; await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === lead.id ? leadActualizado : l)); } catch {} };
601:       const duplicados = buscarDuplicadosCompleto(nombreNuevo, allLeads, vendedorActual);
609:       // 2. Es lead de otro vendedor
610:       if (duplicados.esLeadOtroVendedor) {
611:         alert(`‚ùå ERROR: "${nombreNuevo}" ya es un lead asignado a ${duplicados.vendedorActual}.\n\nNo se permiten leads duplicados entre vendedores.`);
620:             : `‚Ä¢ ${s.nombre} (Lead de ${s.vendedor})`
630:       const historialNuevo: HistorialCambio = { fecha: new Date().toISOString(), campo: 'edicion', valorAnterior: editLead.nombreEmpresa, valorNuevo: formData.nombreEmpresa || '', usuario: editLead.vendedor };
632:       await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${editLead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) });
633:       setLeads(leads.map(l => l.id === editLead.id ? leadActualizado : l)); 
634:       // Actualizar tambi√©n allLeads
635:       setAllLeads(allLeads.map(l => l.id === editLead.id ? leadActualizado : l));
708:     <ModuleTemplate title="Panel de Oportunidades" onBack={onBack}>
752:           const duplicados = detectarDuplicadosExistentes(allLeads);
780:                     ‚ö†Ô∏è {duplicados.size} empresas duplicadas detectadas ({totalDuplicados} leads)
791:                     const lista = Array.from(duplicados.entries()).map(([nombre, leads]) => 
792:                       `‚Ä¢ ${nombre}: ${leads.length} registros (${leads.map(l => l.vendedor).join(', ')})`
794:                     alert(`üìã LEADS DUPLICADOS:\n\n${lista}\n\nüí° Revisa cada uno y elimina o declina los duplicados.`);
826:                   placeholder="Buscar leads..." 
839:             {/* FILTRO VENDEDOR - Select premium */}
842:                 value={filterVendedor} 
843:                 onChange={(e) => setFilterVendedor(e.target.value)} 
852:                 <option value="">Todos los vendedores</option>
853:                 {getVendedoresUnicos().map(v => <option key={v} value={v}>{v}</option>)}
917:         {/* FUNNEL CARD - Premium glass con filtro por vendedor */}
931:                 Funnel de Ventas {!isAdmin && <span className="text-blue-400/70 text-sm ml-2">({vendedorActual})</span>}
933:               {/* Filtro de vendedor - Solo Admin */}
936:                   value={funnelVendedor} 
937:                   onChange={(e) => setFunnelVendedor(e.target.value)} 
944:                   <option value="">Todos los vendedores</option>
945:                   {getVendedoresUnicos().map(v => <option key={v} value={v}>{v}</option>)}
949:             {/* M√©tricas del Funnel - Filtradas seg√∫n vendedor */}
951:               // Filtrar leads seg√∫n contexto
952:               const leadsFunnel = isAdmin 
953:                 ? (funnelVendedor ? leads.filter(l => l.vendedor === funnelVendedor) : leads)
954:                 : leads.filter(l => l.vendedor === vendedorActual);
956:               const total = leadsFunnel.filter(l => !l.eliminado).length;
957:               const cotizados = leadsFunnel.filter(l => !l.eliminado && l.etapaLead === 'Cotizado').length;
958:               const cerrados = leadsFunnel.filter(l => !l.eliminado && l.etapaLead === 'Cerrado').length;
959:               const potencial = leadsFunnel.filter(l => !l.eliminado).reduce((sum, l) => sum + calcularPotencialDesdeCotizaciones(l), 0);
960:               const enRiesgo = leadsFunnel.filter(l => !l.eliminado && getAlertaLead(l).tipo !== null).length;
1037:                 <th onClick={() => handleSort('vendedor')} className="px-3 py-3.5 text-left cursor-pointer hover:text-white transition-colors" style={{ fontSize: '11px', fontWeight: 600, color: 'rgba(180,190,205,0.95)', letterSpacing: '0.06em' }}><div className="flex items-center gap-1"><User className="w-3 h-3" />VENDEDOR<SortIcon field="vendedor" /></div></th>
1078:                       <span className="text-orange-400 font-medium">Cargando leads...</span>
1082:               ) : filteredLeads.length === 0 ? (
1085:                     No hay leads disponibles.
1089:                 filteredLeads.map((lead, index) => {
1091:                   const potencial = calcularPotencialDesdeCotizaciones(lead);
1126:                                     title={`‚ö†Ô∏è DUPLICADO: Este lead aparece ${dupInfo.cantidad} veces${dupInfo.otrosVendedores.length > 0 ? `\nOtros vendedores: ${dupInfo.otrosVendedores.join(', ')}` : '\n(mismo vendedor)'}`}
1360:                       {/* VENDEDOR */}
1361:                       <td className="px-3 py-2" style={{ fontSize: '11px', color: 'rgba(148,163,184,0.90)' }}>{lead.vendedor}</td>
1381:                             <button onClick={() => setCotizacionesModal(lead)} title="PDF / Cotizaciones"
1396:                             {lead.cotizaciones?.filter(c => !c.eliminado).length ? (
1407:                                 {lead.cotizaciones.filter(c => !c.eliminado).length}
1449:               Mostrando {filteredLeads.length} de {leads.filter(l => !l.eliminado).length} leads
1455:       {selectedLead && (<div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setSelectedLead(null)}><div className="bg-slate-900 rounded-2xl border border-slate-700/40 w-[95vw] max-w-[1100px] max-h-[90vh] overflow-y-auto p-6" onClick={(e) => e.stopPropagation()}><div className="flex items-center justify-between mb-4"><h3 className="text-white text-xl font-bold flex items-center gap-2"><Building2 className="w-6 h-6 text-blue-400" />{selectedLead.nombreEmpresa}</h3><button onClick={() => setSelectedLead(null)} className="p-2 rounded-lg hover:bg-slate-800 transition-colors"><X className="w-5 h-5 text-white" /></button></div><div className="grid grid-cols-2 gap-4 mb-4"><div className="p-3 rounded-lg bg-blue-500/5 border border-blue-500/15"><div className="flex items-center gap-2 text-blue-400/70 text-xs mb-1"><Calendar className="w-3 h-3" />Creacion</div><div className="text-white font-semibold">{formatDateTime(selectedLead.fechaCaptura)}</div></div><div className="p-3 rounded-lg bg-orange-500/5 border border-orange-500/15"><div className="flex items-center gap-2 text-orange-400/70 text-xs mb-1"><Clock className="w-3 h-3" />Ultima Modificacion</div><div className="text-white font-semibold">{formatDateTime(selectedLead.fechaActualizacion) || formatDateTime(selectedLead.fechaCaptura)}</div></div></div><div className="grid grid-cols-3 gap-4 text-sm mb-4"><div className="p-3 rounded-lg bg-slate-800/40 border border-slate-700/25"><div className="text-blue-400/70 text-xs mb-1">Contacto</div><div className="text-white font-semibold">{selectedLead.nombreContacto}</div><div className="text-slate-400">{selectedLead.correoElectronico}</div></div><div className="p-3 rounded-lg bg-slate-800/40 border border-slate-700/25"><div className="text-blue-400/70 text-xs mb-1">Servicio</div><div className="flex flex-wrap gap-1">{(selectedLead.tipoServicio||[]).map((t,i)=><span key={i} className="px-2 py-0.5 rounded bg-slate-700/40 text-slate-300 text-xs border border-slate-600/25">{t}</span>)}</div></div><div className="p-3 rounded-lg bg-slate-800/40 border border-slate-700/25"><div className="text-blue-400/70 text-xs mb-1">Viaje</div><div className="flex flex-wrap gap-1">{(selectedLead.tipoViaje||[]).map((t,i)=><span key={i} className="px-2 py-0.5 rounded bg-blue-500/10 text-blue-300 text-xs border border-blue-500/20">{t}</span>)}</div></div><div className="p-3 rounded-lg bg-slate-800/40 border border-slate-700/25 col-span-2"><div className="text-blue-400/70 text-xs mb-1">Rutas</div><div className="text-white text-sm">{selectedLead.principalesRutas || '-'}</div></div><div className="p-3 rounded-lg bg-slate-800/40 border border-slate-700/25"><div className="text-blue-400/70 text-xs mb-1">Viajes/Mes</div><div className="text-white font-bold text-lg">{selectedLead.viajesPorMes || '-'}</div></div></div>{(() => { const pot = calcularPotencialDesdeCotizaciones(selectedLead); return pot > 0 ? <div className="p-4 rounded-lg bg-teal-500/5 border border-teal-500/15 mb-4"><div className="text-teal-400/70 text-xs mb-1">$ Potencial Mensual</div><div className="text-teal-400 font-bold text-3xl">${pot.toLocaleString('es-MX')} MXN</div></div> : null; })()}<div className="flex justify-between items-center text-sm text-slate-500"><span>Vendedor: {selectedLead.vendedor}</span><span>Etapa: {selectedLead.etapaLead || 'Prospecto'}</span></div></div></div>)}
1459:       {cotizacionesModal && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setCotizacionesModal(null)}><div className="bg-slate-900 rounded-2xl border border-slate-700/40 w-[900px] max-h-[85vh] overflow-y-auto p-6" onClick={(e) => e.stopPropagation()}><div className="flex items-center justify-between mb-4"><h3 className="text-white text-xl font-bold flex items-center gap-2"><FileText className="w-5 h-5 text-blue-400" />Cotizaciones - {cotizacionesModal.nombreEmpresa}</h3><button onClick={() => setCotizacionesModal(null)} className="p-2 rounded-lg hover:bg-slate-800 transition-colors"><X className="w-5 h-5 text-white" /></button></div><div className="mb-4"><label className={`flex items-center justify-center gap-2 px-4 py-3 rounded-xl ${analizando ? 'bg-blue-600/40' : 'bg-blue-600/80 hover:bg-blue-600'} text-white cursor-pointer transition-colors`}>{analizando ? <><Loader2 className="w-5 h-5 animate-spin" /><span>{statusMsg}</span></> : <><Upload className="w-5 h-5" /><span className="font-semibold">Subir Cotizacion (PDF)</span></>}<input type="file" accept="application/pdf" className="hidden" disabled={analizando} onChange={(e) => { if (e.target.files?.length) handleSubirCotizaciones(e.target.files, cotizacionesModal); e.target.value = ''; }} /></label></div><div className="space-y-3">{(!cotizacionesModal.cotizaciones || !cotizacionesModal.cotizaciones.filter(c => !c.eliminado).length) ? (<div className="text-center py-6 text-slate-500">No hay cotizaciones.</div>) : (cotizacionesModal.cotizaciones.filter(c => !c.eliminado).map((cot, i) => (<div key={i} className="p-4 rounded-lg bg-slate-800/40 border border-slate-700/25"><div className="flex items-center justify-between mb-2"><div className="flex items-center gap-2"><FileText className="w-4 h-4 text-blue-400" /><span className="text-white font-semibold">{cot.nombre}</span><span className="text-slate-600 text-xs">{formatDate(cot.fecha)}</span></div><div className="flex gap-2">{cot.url && <button onClick={() => setPdfPreview(cot.url)} className="px-2 py-1 rounded bg-slate-700/40 hover:bg-blue-500/10 text-slate-400 hover:text-blue-400 text-xs flex items-center gap-1 transition-colors border border-slate-600/25"><Eye className="w-3 h-3" />Ver</button>}{cot.url && <a href={cot.url} download={cot.nombre} className="px-2 py-1 rounded bg-slate-700/40 hover:bg-blue-500/10 text-slate-400 hover:text-blue-400 text-xs flex items-center gap-1 transition-colors border border-slate-600/25"><Download className="w-3 h-3" /></a>}<button onClick={() => handleEliminarCotizacion(cotizacionesModal, cotizacionesModal.cotizaciones?.indexOf(cot) || i)} className="px-2 py-1 rounded bg-slate-700/40 hover:bg-red-500/10 text-slate-400 hover:text-red-400 text-xs transition-colors border border-slate-600/25"><Trash2 className="w-3 h-3" /></button></div></div>{cot.lineas && cot.lineas.length > 0 && (<div className="mt-3 p-3 rounded bg-teal-500/5 border border-teal-500/15"><div className="flex items-center gap-1 mb-2"><CheckCircle className="w-3 h-3 text-teal-400" /><span className="text-teal-400/70 text-xs font-semibold">Lineas Cotizadas</span></div><div className="space-y-2">{cot.lineas.map((linea, idx) => (<div key={idx} className="flex justify-between items-center text-xs p-2 rounded bg-slate-900/40"><div className="flex-1 flex items-center gap-2"><MapPin className="w-3 h-3 text-slate-600" /><span className="text-white">{linea.origen}</span><ArrowRight className="w-3 h-3 text-slate-600" /><span className="text-white">{linea.destino}</span><span className={`ml-2 px-1.5 py-0.5 rounded border ${getTipoViajeColor(linea.tipoViaje)}`}>{linea.tipoViaje}</span></div><div className="text-slate-400">{linea.viajes} x ${linea.tarifa.toLocaleString('es-MX')} {linea.moneda}</div><div className="text-teal-400 font-semibold ml-4">${linea.subtotalMXN.toLocaleString('es-MX')}</div></div>))}</div><div className="mt-3 pt-3 border-t border-teal-500/15 flex justify-between items-center"><span className="text-teal-400/70 font-semibold">TOTAL:</span><span className="text-teal-400 font-bold text-xl">${cot.potencialMXN?.toLocaleString('es-MX')}</span></div></div>)}</div>)))}</div><button onClick={() => setCotizacionesModal(null)} className="mt-4 w-full px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white transition-colors">Cerrar</button></div></div>)}
1641:                         // Liberar lead (quitar vendedor)
1645:                           vendedor: '',
1713:     </ModuleTemplate>


==================== ServicioClientesModule.tsx ====================
-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
10:     <ModuleTemplate title="Servicio A Clientes" onBack={onBack} headerImage={MODULE_IMAGES.SERVICIO_CLIENTES}>
22:     </ModuleTemplate>


==================== UbicacionDetallada.tsx ====================
-- pattern: functions\/v1
30:     fetch(`https://${import.meta.env.VITE_SUPABASE_PROJECT_ID || 'ynpjtamjhqstwuazedqu'}.supabase.co/functions/v1/make-server-d84b50bb/api-keys/google-maps`, {

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
8:   GRANJAS_CARROLL_COORDS
91:         background: ubicacion.esGranjasCarroll ? '#ECFDF5' : '#EFF6FF',
92:         border: `1.5px solid ${ubicacion.esGranjasCarroll ? '#10B981' : '#3B82F6'}`
100:             color: ubicacion.esGranjasCarroll ? '#065F46' : '#1E40AF'


==================== UbicacionGPS.tsx ====================
-- pattern: functions\/v1
33:             `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/detectar-geocerca`,

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
33:             `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/carroll/detectar-geocerca`,

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
6: interface UbicacionGPSProps {
24: export const UbicacionGPS = ({ latitude, longitude, address, onVerMapa, isCache, cacheAge }: UbicacionGPSProps) => {
204:               {address.split(',')[0]?.substring(0, 25) || 'Ubicaci√≥n GPS'}...
216:               Live GPS


==================== UbicacionInteligenteCompacta.tsx ====================

==================== UsuariosModule.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
9:   rol: 'admin' | 'ventas' | 'operaciones' | 'custom';
10:   permisosCustom?: string[];
16: interface UsuariosModuleProps {
20: // M√≥dulos disponibles para permisos custom
26:   { id: 'control-equipo', nombre: 'Control de Equipo' },
35: // Usuarios predefinidos del sistema
36: const USUARIOS_INICIALES: Usuario[] = [
42:     rol: 'admin',
52:     rol: 'operaciones',
62:     rol: 'operaciones',
72:     rol: 'ventas',
82:     rol: 'ventas',
92:     rol: 'ventas',
102:     rol: 'ventas',
112:     rol: 'ventas',
119: export const UsuariosModule = ({ onBack }: UsuariosModuleProps) => {
120:   const [usuarios, setUsuarios] = useState<Usuario[]>([]);
127:     rol: 'ventas',
128:     permisosCustom: [],
132:   // Cargar usuarios desde localStorage o usar los iniciales
134:     const savedUsers = localStorage.getItem('fx27-usuarios');
137:         setUsuarios(JSON.parse(savedUsers));
139:         setUsuarios(USUARIOS_INICIALES);
140:         localStorage.setItem('fx27-usuarios', JSON.stringify(USUARIOS_INICIALES));
143:       setUsuarios(USUARIOS_INICIALES);
144:       localStorage.setItem('fx27-usuarios', JSON.stringify(USUARIOS_INICIALES));
154:     if (nuevoUsuario.rol === 'custom' && (!nuevoUsuario.permisosCustom || nuevoUsuario.permisosCustom.length === 0)) {
155:       alert('Debes seleccionar al menos un m√≥dulo para el rol Custom');
164:       rol: nuevoUsuario.rol || 'ventas',
165:       permisosCustom: nuevoUsuario.permisosCustom || [],
171:     const nuevosUsuarios = [...usuarios, usuario];
172:     setUsuarios(nuevosUsuarios);
173:     localStorage.setItem('fx27-usuarios', JSON.stringify(nuevosUsuarios));
179:       rol: 'ventas',
180:       permisosCustom: [],
189:       const nuevosUsuarios = usuarios.map(u => 
192:       setUsuarios(nuevosUsuarios);
193:       localStorage.setItem('fx27-usuarios', JSON.stringify(nuevosUsuarios));
200:       const nuevosUsuarios = usuarios.filter(u => u.id !== id);
201:       setUsuarios(nuevosUsuarios);
202:       localStorage.setItem('fx27-usuarios', JSON.stringify(nuevosUsuarios));
211:     const permisosActuales = nuevoUsuario.permisosCustom || [];
212:     const nuevosPermisos = permisosActuales.includes(moduloId)
213:       ? permisosActuales.filter(p => p !== moduloId)
214:       : [...permisosActuales, moduloId];
216:     setNuevoUsuario({ ...nuevoUsuario, permisosCustom: nuevosPermisos });
231:   const getRolBadgeColor = (rol: string) => {
232:     switch (rol) {
241:   const getRolLabel = (rol: string) => {
242:     switch (rol) {
247:       default: return rol;
257:           alt="Usuarios"
303:             Gesti√≥n de Usuarios
370:                 value={nuevoUsuario.rol}
371:                 onChange={(e) => setNuevoUsuario({ ...nuevoUsuario, rol: e.target.value as any, permisosCustom: [] })}
382:             {/* Permisos Custom */}
383:             {nuevoUsuario.rol === 'custom' && (
393:                         checked={nuevoUsuario.permisosCustom?.includes(modulo.id) || false}
425:         {/* Tabla de Usuarios */}
438:                     ROL
455:                 {usuarios.map((usuario) => (
465:                         className={`px-3 py-1 rounded-full text-xs ${getRolBadgeColor(usuario.rol)}`}
468:                         {getRolLabel(usuario.rol)}
501:                         {usuario.rol !== 'admin' && (
522:             Total de usuarios: <span className="text-white" style={{ fontFamily: "'Orbitron', sans-serif", fontWeight: 600 }}>{usuarios.length}</span>

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
29:   { id: 'cotizaciones', nombre: 'Cotizaciones' },
223:       year: 'numeric', 


==================== UtileriasModule.tsx ====================
-- pattern: functions\/v1
22:       const endpoint = `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/backup/${type}`;

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
2: import { ModuleTemplate } from './ModuleTemplate';
12: type GestorSection = 'cotizaciones' | 'contratos' | 'documentos' | 'imagenes' | 'otros' | 'formatos' | null;
22:       const endpoint = `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/backup/${type}`;
59:       <ModuleTemplate title="Utiler√≠as" onBack={onBack} headerImage={MODULE_IMAGES.UTILERIAS}>
88:                   Descargar respaldos de leads
125:       </ModuleTemplate>
132:       <ModuleTemplate title="Utiler√≠as ‚Ä∫ Backup" onBack={() => setActiveSubModule(null)} headerImage={MODULE_IMAGES.UTILERIAS}>
173:                     Leads eliminados
205:                     Leads actuales
256:       </ModuleTemplate>
263:       <ModuleTemplate title="Utiler√≠as ‚Ä∫ Gestor de Archivos" onBack={() => setActiveSubModule(null)} headerImage={MODULE_IMAGES.UTILERIAS}>
266:             {/* Cotizaciones */}
268:               onClick={() => setActiveGestorSection('cotizaciones')}
279:                 Cotizaciones
398:       </ModuleTemplate>


==================== VariablesCotizacionModule.tsx ====================
-- pattern: functions\/v1
121:       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/config/tarifas`, {
192:                       const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/config/google-maps-key`, {

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
166:     <ModuleTemplate title="Variables de Cotizaci√≥n" onBack={onBack} headerImage={MODULE_IMAGES.COTIZACIONES}>
353:               <strong>NOTA:</strong> Estas variables se usar√°n autom√°ticamente en el m√≥dulo de Cotizaciones. Ruta corta {'<'} 500 km (o 300 mi), Ruta larga {'>='} 500 km (o 300 mi).
358:     </ModuleTemplate>


==================== VentasModule.tsx ====================
-- pattern: supabase\.from\(
112:       let query = supabase.from('ventas_maestro').select('*').eq('year', year);

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
8: // üìã PERMISOS DE USUARIOS - ACTUALIZADOS 18/DIC/2025
10: const PERMISOS: { [email: string]: { vendedor?: string; verTodo: boolean } } = {
42:     "JOHNSON CONTROLS": ["JOHNSON CONTROL", "JCI", "JOHNSON"],
50:   CLIENTES_DEDICADO: ['BAFAR', 'NATURESWEET', 'BARCEL', 'GRANJAS CARROLL', 'LALA'],
94:   const [chatMsgs, setChatMsgs] = useState<{role: string; content: string}[]>([]);
98:   // Obtener permisos del usuario
100:     const permiso = PERMISOS[userEmail.toLowerCase()];
200:     setChatMsgs(prev => [...prev, { role: 'user', content: userMsg }]);
238:           messages: [...chatMsgs.map(m => ({ role: m.role, content: m.content })), { role: 'user', content: userMsg }]
244:       setChatMsgs(prev => [...prev, { role: 'assistant', content: assistantMsg }]);
247:       setChatMsgs(prev => [...prev, { role: 'assistant', content: 'Error de conexi√≥n con IA. Verifica la API key.' }]);
295:         <div className="space-y-2 max-h-64 overflow-y-auto scrollbar-thin scrollbar-thumb-white/10">
324:       <div className="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-white/10">
333:           <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
334:             <div className={`max-w-[80%] rounded-xl px-4 py-2 ${m.role === 'user' ? 'bg-orange-500/20 text-white' : 'bg-white/10 text-white/90'}`}>

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
1: import { ModuleTemplate } from './ModuleTemplate';
10: const PERMISOS: { [email: string]: { vendedor?: string; verTodo: boolean } } = {
18:   'isis.estrada@wexpress.com.mx': { vendedor: 'ISIS', verTodo: false },
19:   'paloma.oliva@speedyhaul.com.mx': { vendedor: 'PALOMA', verTodo: false },
85:   const [year, setYear] = useState(2025);
105:   const vendedorFiltro = permisoUsuario.vendedor || '';
112:       let query = supabase.from('ventas_maestro').select('*').eq('year', year);
114:       // üîê Filtro por vendedor (ISIS/PALOMA solo ven sus clientes)
115:       if (!esAdmin && vendedorFiltro) {
116:         query = query.eq('vendedor', vendedorFiltro);
174:   }, [year, filtros, esAdmin, vendedorFiltro]);
206: Datos actuales (${year}):
221: Usuario: ${userEmail} (${esAdmin ? 'Admin - ve todo' : `Vendedor  - solo sus clientes`})
309:       {/* Info vendedor (solo si no es admin) */}
310:       {!esAdmin && vendedorFiltro && (
314:             <span className="text-sm">Mostrando solo clientes asignados a <strong>{vendedorFiltro}</strong></span>
425:     <ModuleTemplate title="Ventas" subtitle={esAdmin ? "Dashboard General" : `Clientes ${vendedorFiltro}`} onBack={onBack} backgroundImage={MODULE_IMAGES.ventas}>
438:           <select value={year} onChange={e => setYear(Number(e.target.value))} className="bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-white text-xs">
452:     </ModuleTemplate>


==================== VerificadorGoogleMapsAPI.tsx ====================
-- pattern: functions\/v1
33:         `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/api-keys/google-maps`,

-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
63:       // 2. Probar Geocoding API con coordenadas de Granjas Carroll
66:         mensaje: 'Probando Geocoding API con coordenadas de Granjas Carroll...'
208:                       üìç DIRECCI√ìN OBTENIDA (Granjas Carroll):
354:               Granjas Carroll

-- pattern: ventas_maestro|leads|cotizaciones|gps|placa|plate|customer_service|vendedor|cxc|year
338:                       Revisa <code style={{ background: '#D1FAE5', padding: '2px 6px', borderRadius: '4px' }}>/components/fx27/EjemploUbicacionGPS.tsx</code>


==================== VistaClientesCarroll.tsx ====================
-- pattern: PERMISOS|USUARIOS|AUTORIZADOS|rol|role
5: interface VistaClientesCarrollProps {
20: export const VistaClientesCarroll = ({ onBack, onVerMapa }: VistaClientesCarrollProps) => {
100:                   Vista Clientes ¬∑ Granjas Carroll


=== DONE ===
OUTPUT: C:\Users\timon\Downloads\izzi_sync\FX27_AUDIT_READONLY_20251222_141223.txt
