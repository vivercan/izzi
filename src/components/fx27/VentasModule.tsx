import { ModuleTemplate } from './ModuleTemplate';
import { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { MODULE_IMAGES } from '../../assets/module-images';
import { TrendingUp, DollarSign, Building2, Loader2, Truck, Globe, RefreshCw, Send, Bot, Sparkles, BarChart3, Filter, X, Package, Gauge, Check } from 'lucide-react';
import { supabase } from '../../utils/supabase/client';

interface VentasModuleProps { onBack: () => void; }
interface Filtros { fechaInicio: string; fechaFin: string; segmento: string; tipo: string; empresa: string; clientes: string[]; tractos: string[]; cajas: string[]; estadoOrigen: string; estadoDestino: string; vendedor: string; division: string; kmsMin: string; kmsMax: string; }
interface StatsData { total_viajes: number; total_ventas: number; total_kms: number; por_segmento: { [k: string]: { viajes: number; ventas: number } }; por_empresa: { [k: string]: { viajes: number; ventas: number } }; por_tipo: { [k: string]: { viajes: number; ventas: number } }; }
interface TopItem { nombre: string; viajes: number; ventas: number; }

const FILTROS_INIT: Filtros = { fechaInicio: '', fechaFin: '', segmento: '', tipo: '', empresa: '', clientes: [], tractos: [], cajas: [], estadoOrigen: '', estadoDestino: '', vendedor: '', division: '', kmsMin: '', kmsMax: '' };
const PERMISOS: { [email: string]: { vendedor?: string; verTodo: boolean } } = { 'admin@grupofx27.com': { verTodo: true }, 'juanviverosv@gmail.com': { verTodo: true }, 'isis@grupofx27.com': { vendedor: 'ISIS', verTodo: false }, 'paloma@grupofx27.com': { vendedor: 'PALOMA', verTodo: false } };

function MultiSelect({ label, options, selected, onChange, placeholder }: { label: string; options: string[]; selected: string[]; onChange: (v: string[]) => void; placeholder: string; }) {
  const [open, setOpen] = useState(false); const [search, setSearch] = useState(''); const ref = useRef<HTMLDivElement>(null);
  useEffect(() => { const h = (e: MouseEvent) => { if (ref.current && !ref.current.contains(e.target as Node)) setOpen(false); }; document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); }, []);
  const filtered = options.filter(o => o.toLowerCase().includes(search.toLowerCase()));
  const toggle = (item: string) => { if (selected.includes(item)) onChange(selected.filter(s => s !== item)); else onChange([...selected, item]); };
  return (<div ref={ref} className="relative"><label className="text-white/40 text-xs mb-1 block">{label}</label><div onClick={() => setOpen(!open)} className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm cursor-pointer hover:border-white/20 flex items-center justify-between"><span className={selected.length ? 'text-white' : 'text-white/30'}>{selected.length ? `${selected.length} sel.` : placeholder}</span><span className="text-white/40 text-xs">▼</span></div>{open && (<div className="absolute z-50 mt-1 w-full bg-slate-900 border border-white/10 rounded-lg shadow-xl max-h-48 overflow-hidden"><div className="p-2 border-b border-white/10"><input type="text" value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Buscar..." className="w-full bg-white/5 border border-white/10 rounded px-2 py-1 text-sm text-white placeholder-white/30 focus:outline-none" onClick={(e) => e.stopPropagation()} /></div><div className="overflow-y-auto max-h-36 scrollbar-thin scrollbar-thumb-white/10">{selected.length > 0 && <button onClick={() => onChange([])} className="w-full px-3 py-1 text-left text-xs text-red-400 hover:bg-white/5 border-b border-white/10">Limpiar</button>}{filtered.slice(0, 50).map(item => (<div key={item} onClick={() => toggle(item)} className={`px-3 py-1 text-xs cursor-pointer flex items-center gap-2 hover:bg-white/5 ${selected.includes(item) ? 'bg-orange-500/10 text-orange-400' : 'text-white/70'}`}><div className={`w-3 h-3 rounded border ${selected.includes(item) ? 'bg-orange-500 border-orange-500' : 'border-white/20'} flex items-center justify-center`}>{selected.includes(item) && <Check className="w-2 h-2 text-white" />}</div><span className="truncate">{item}</span></div>))}</div></div>)}</div>);
}

export function VentasModule({ onBack }: VentasModuleProps) {
  const [vista, setVista] = useState<'dashboard' | 'chat'>('dashboard');
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState<StatsData | null>(null);
  const [topClientes, setTopClientes] = useState<TopItem[]>([]);
  const [topTractos, setTopTractos] = useState<TopItem[]>([]);
  const [topCajas, setTopCajas] = useState<TopItem[]>([]);
  const [datosMensuales, setDatosMensuales] = useState<{ [k: string]: { viajes: number; ventas: number } }>({});
  const [ultimaAct, setUltimaAct] = useState('');
  const [filtrosAplicados, setFiltrosAplicados] = useState<Filtros>(FILTROS_INIT);
  const [filtrosTemp, setFiltrosTemp] = useState<Filtros>(FILTROS_INIT);
  const [filtrosOpen, setFiltrosOpen] = useState(false);
  const [year, setYear] = useState(2025);
  const [yearAplicado, setYearAplicado] = useState(2025);
  const [opClientes, setOpClientes] = useState<string[]>([]);
  const [opTractos, setOpTractos] = useState<string[]>([]);
  const [opCajas, setOpCajas] = useState<string[]>([]);
  const [opEstados, setOpEstados] = useState<string[]>([]);
  const [chatMsgs, setChatMsgs] = useState<{ role: 'user' | 'assistant'; content: string }[]>([]);
  const [chatIn, setChatIn] = useState('');
  const [chatLoad, setChatLoad] = useState(false);
  const [userPermisos, setUserPermisos] = useState<{ vendedor?: string; verTodo: boolean }>({ verTodo: true });

  useEffect(() => { const getUser = async () => { const { data: { user } } = await supabase.auth.getUser(); if (user?.email) { const p = PERMISOS[user.email] || { verTodo: false }; setUserPermisos(p); if (p.vendedor && !p.verTodo) { setFiltrosAplicados(prev => ({ ...prev, vendedor: p.vendedor! })); setFiltrosTemp(prev => ({ ...prev, vendedor: p.vendedor! })); } } }; getUser(); }, []);

  const cargarOpciones = useCallback(async () => {
    const { data: c } = await supabase.from('ventas_maestro').select('cliente_consolidado').not('cliente_consolidado', 'is', null); if (c) setOpClientes([...new Set(c.map(x => x.cliente_consolidado))].filter(Boolean).sort());
    const { data: t } = await supabase.from('ventas_maestro').select('tracto').not('tracto', 'is', null); if (t) setOpTractos([...new Set(t.map(x => x.tracto))].filter(Boolean).sort());
    const { data: ca } = await supabase.from('ventas_maestro').select('caja').not('caja', 'is', null); if (ca) setOpCajas([...new Set(ca.map(x => x.caja))].filter(Boolean).sort());
    const { data: e } = await supabase.from('ventas_maestro').select('estado_origen, estado_destino'); if (e) setOpEstados([...new Set([...e.map(x => x.estado_origen), ...e.map(x => x.estado_destino)].filter(Boolean))].sort());
  }, []);

  const cargarDatos = useCallback(async () => {
    setLoading(true);
    try {
      const { data: uf } = await supabase.from('ventas_maestro').select('fecha_factura').order('fecha_factura', { ascending: false }).limit(1).single();
      if (uf?.fecha_factura) setUltimaAct(`Datos: ${new Date(uf.fecha_factura).toLocaleDateString('es-MX')}`);
      let q = supabase.from('ventas_maestro').select('*').gte('fecha_factura', `${yearAplicado}-01-01`).lte('fecha_factura', `${yearAplicado}-12-31`);
      if (!userPermisos.verTodo && userPermisos.vendedor) q = q.eq('ejecutivo_ventas', userPermisos.vendedor);
      else if (filtrosAplicados.vendedor) q = q.eq('ejecutivo_ventas', filtrosAplicados.vendedor);
      if (filtrosAplicados.fechaInicio) q = q.gte('fecha_factura', filtrosAplicados.fechaInicio);
      if (filtrosAplicados.fechaFin) q = q.lte('fecha_factura', filtrosAplicados.fechaFin);
      if (filtrosAplicados.segmento) q = q.eq('segmento', filtrosAplicados.segmento);
      if (filtrosAplicados.tipo) q = q.eq('tipo', filtrosAplicados.tipo);
      if (filtrosAplicados.empresa) q = q.eq('empresa', filtrosAplicados.empresa);
      if (filtrosAplicados.estadoOrigen) q = q.eq('estado_origen', filtrosAplicados.estadoOrigen);
      if (filtrosAplicados.estadoDestino) q = q.eq('estado_destino', filtrosAplicados.estadoDestino);
      if (filtrosAplicados.division) q = q.eq('division', filtrosAplicados.division);
      if (filtrosAplicados.kmsMin) q = q.gte('kms_viaje', parseFloat(filtrosAplicados.kmsMin));
      if (filtrosAplicados.kmsMax) q = q.lte('kms_viaje', parseFloat(filtrosAplicados.kmsMax));
      const { data: vd } = await q;
      if (vd) {
        let d = vd;
        if (filtrosAplicados.clientes.length) d = d.filter(x => filtrosAplicados.clientes.includes(x.cliente_consolidado));
        if (filtrosAplicados.tractos.length) d = d.filter(x => filtrosAplicados.tractos.includes(x.tracto));
        if (filtrosAplicados.cajas.length) d = d.filter(x => filtrosAplicados.cajas.includes(x.caja));
        const tv = d.length, tven = d.reduce((s, r) => s + (r.ventas || 0), 0), tkm = d.reduce((s, r) => s + (r.kms_viaje || 0), 0);
        const pSeg: any = {}, pEmp: any = {}, pTipo: any = {};
        d.forEach(r => { const sg = r.segmento || 'SIN', em = r.empresa || 'SIN', tp = r.tipo || 'NAC'; if (!pSeg[sg]) pSeg[sg] = { viajes: 0, ventas: 0 }; if (!pEmp[em]) pEmp[em] = { viajes: 0, ventas: 0 }; if (!pTipo[tp]) pTipo[tp] = { viajes: 0, ventas: 0 }; pSeg[sg].viajes++; pSeg[sg].ventas += r.ventas || 0; pEmp[em].viajes++; pEmp[em].ventas += r.ventas || 0; pTipo[tp].viajes++; pTipo[tp].ventas += r.ventas || 0; });
        setStats({ total_viajes: tv, total_ventas: tven, total_kms: tkm, por_segmento: pSeg, por_empresa: pEmp, por_tipo: pTipo });
        const cs: any = {}; d.forEach(r => { const c = r.cliente_consolidado || 'SIN'; if (!cs[c]) cs[c] = { viajes: 0, ventas: 0 }; cs[c].viajes++; cs[c].ventas += r.ventas || 0; }); setTopClientes(Object.entries(cs).map(([n, s]: any) => ({ nombre: n, ...s })).sort((a, b) => b.ventas - a.ventas).slice(0, 10));
        const ts: any = {}; d.forEach(r => { const t = r.tracto; if (!t) return; if (!ts[t]) ts[t] = { viajes: 0, ventas: 0 }; ts[t].viajes++; ts[t].ventas += r.ventas || 0; }); setTopTractos(Object.entries(ts).map(([n, s]: any) => ({ nombre: n, ...s })).sort((a, b) => b.ventas - a.ventas).slice(0, 10));
        const cjs: any = {}; d.forEach(r => { const c = r.caja; if (!c) return; if (!cjs[c]) cjs[c] = { viajes: 0, ventas: 0 }; cjs[c].viajes++; cjs[c].ventas += r.ventas || 0; }); setTopCajas(Object.entries(cjs).map(([n, s]: any) => ({ nombre: n, ...s })).sort((a, b) => b.ventas - a.ventas).slice(0, 10));
        const pm: any = {}; d.forEach(r => { if (!r.fecha_factura) return; const k = r.fecha_factura.substring(0, 7); if (!pm[k]) pm[k] = { viajes: 0, ventas: 0 }; pm[k].viajes++; pm[k].ventas += r.ventas || 0; }); setDatosMensuales(pm);
      }
    } catch (e) { console.error(e); } finally { setLoading(false); }
  }, [yearAplicado, filtrosAplicados, userPermisos]);

  useEffect(() => { cargarOpciones(); }, [cargarOpciones]);
  useEffect(() => { cargarDatos(); }, [cargarDatos]);

  const abrirFiltros = () => { setFiltrosTemp({ ...filtrosAplicados }); setYear(yearAplicado); setFiltrosOpen(true); };
  const aplicarFiltros = () => { setFiltrosAplicados({ ...filtrosTemp }); setYearAplicado(year); setFiltrosOpen(false); };
  const limpiarFiltros = () => { const base = { ...FILTROS_INIT }; if (!userPermisos.verTodo && userPermisos.vendedor) base.vendedor = userPermisos.vendedor; setFiltrosTemp(base); };
  const enviarChat = async () => { if (!chatIn.trim() || chatLoad) return; const p = chatIn.trim(); setChatIn(''); setChatMsgs(m => [...m, { role: 'user', content: p }]); setChatLoad(true); try { const { data } = await supabase.functions.invoke('ventas-api', { body: { action: 'ai_analysis', pregunta: p, year: yearAplicado } }); setChatMsgs(m => [...m, { role: 'assistant', content: data?.respuesta || 'Error' }]); } catch { setChatMsgs(m => [...m, { role: 'assistant', content: 'Error' }]); } finally { setChatLoad(false); } };

  const fmt = (n: number) => '$' + n.toLocaleString('es-MX');
  const fmtN = (n: number) => n.toLocaleString('es-MX');
  const MES = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  const nFiltros = useMemo(() => { let c = 0; if (filtrosAplicados.fechaInicio) c++; if (filtrosAplicados.fechaFin) c++; if (filtrosAplicados.segmento) c++; if (filtrosAplicados.tipo) c++; if (filtrosAplicados.empresa) c++; if (filtrosAplicados.clientes.length) c++; if (filtrosAplicados.tractos.length) c++; if (filtrosAplicados.cajas.length) c++; if (filtrosAplicados.estadoOrigen) c++; if (filtrosAplicados.estadoDestino) c++; if (filtrosAplicados.vendedor && userPermisos.verTodo) c++; if (filtrosAplicados.division) c++; if (filtrosAplicados.kmsMin) c++; if (filtrosAplicados.kmsMax) c++; return c; }, [filtrosAplicados, userPermisos]);
  const esUSA = filtrosAplicados.division === 'TROB_USA' || filtrosAplicados.empresa === 'TROB_USA';
  const moneda = esUSA ? 'USD' : 'MXN';

  const ModalFiltros = () => filtrosOpen ? (<div className="fixed inset-0 z-50 flex items-start justify-center pt-12" onClick={() => setFiltrosOpen(false)}><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" /><div className="relative bg-slate-900/95 border border-white/10 rounded-xl p-4 w-[750px] max-h-[80vh] overflow-y-auto shadow-2xl" onClick={e => e.stopPropagation()}><div className="flex items-center justify-between mb-3"><h3 className="text-white font-medium text-sm flex items-center gap-2"><Filter className="w-4 h-4 text-orange-400" />Filtros</h3><button onClick={() => setFiltrosOpen(false)} className="p-1 hover:bg-white/10 rounded"><X className="w-4 h-4 text-white/60" /></button></div><div className="grid grid-cols-4 gap-3"><div><label className="text-white/40 text-xs mb-1 block">Año</label><select value={year} onChange={e => setYear(Number(e.target.value))} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs">{[2025, 2024, 2023, 2022, 2021].map(y => <option key={y} value={y}>{y}</option>)}</select></div><div><label className="text-white/40 text-xs mb-1 block">División</label><select value={filtrosTemp.division} onChange={e => setFiltrosTemp({ ...filtrosTemp, division: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs"><option value="">Todas</option><option value="GRUPO_LOMA">Grupo Loma (MXN)</option><option value="TROB_USA">TROB USA (USD)</option></select></div><div><label className="text-white/40 text-xs mb-1 block">Fecha Inicio</label><input type="date" value={filtrosTemp.fechaInicio} onChange={e => setFiltrosTemp({ ...filtrosTemp, fechaInicio: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" /></div><div><label className="text-white/40 text-xs mb-1 block">Fecha Fin</label><input type="date" value={filtrosTemp.fechaFin} onChange={e => setFiltrosTemp({ ...filtrosTemp, fechaFin: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" /></div>{userPermisos.verTodo && (<div><label className="text-white/40 text-xs mb-1 block">Vendedor</label><select value={filtrosTemp.vendedor} onChange={e => setFiltrosTemp({ ...filtrosTemp, vendedor: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs"><option value="">Todos</option><option value="ISIS">ISIS</option><option value="PALOMA">PALOMA</option></select></div>)}<div><label className="text-white/40 text-xs mb-1 block">Segmento</label><select value={filtrosTemp.segmento} onChange={e => setFiltrosTemp({ ...filtrosTemp, segmento: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs"><option value="">Todos</option><option value="IMPEX">IMPEX</option><option value="DEDICADO">DEDICADO</option></select></div><div><label className="text-white/40 text-xs mb-1 block">Tipo</label><select value={filtrosTemp.tipo} onChange={e => setFiltrosTemp({ ...filtrosTemp, tipo: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs"><option value="">Todos</option><option value="IMPO">IMPO</option><option value="EXPO">EXPO</option><option value="NAC">NAC</option></select></div><div><label className="text-white/40 text-xs mb-1 block">Empresa</label><select value={filtrosTemp.empresa} onChange={e => setFiltrosTemp({ ...filtrosTemp, empresa: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs"><option value="">Todas</option><option value="TROB">TROB</option><option value="WE">WE</option><option value="SHI">SHI</option><option value="TROB_USA">TROB USA</option></select></div><div><label className="text-white/40 text-xs mb-1 block">Edo Origen</label><select value={filtrosTemp.estadoOrigen} onChange={e => setFiltrosTemp({ ...filtrosTemp, estadoOrigen: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs"><option value="">Todos</option>{opEstados.map(x => <option key={x} value={x}>{x}</option>)}</select></div><div><label className="text-white/40 text-xs mb-1 block">Edo Destino</label><select value={filtrosTemp.estadoDestino} onChange={e => setFiltrosTemp({ ...filtrosTemp, estadoDestino: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs"><option value="">Todos</option>{opEstados.map(x => <option key={x} value={x}>{x}</option>)}</select></div><div><label className="text-white/40 text-xs mb-1 block">KMs Min</label><input type="number" value={filtrosTemp.kmsMin} onChange={e => setFiltrosTemp({ ...filtrosTemp, kmsMin: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" /></div><div><label className="text-white/40 text-xs mb-1 block">KMs Max</label><input type="number" value={filtrosTemp.kmsMax} onChange={e => setFiltrosTemp({ ...filtrosTemp, kmsMax: e.target.value })} className="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs" /></div><MultiSelect label="Clientes" options={opClientes} selected={filtrosTemp.clientes} onChange={v => setFiltrosTemp({ ...filtrosTemp, clientes: v })} placeholder="Seleccionar..." /><MultiSelect label="Tractos" options={opTractos} selected={filtrosTemp.tractos} onChange={v => setFiltrosTemp({ ...filtrosTemp, tractos: v })} placeholder="Seleccionar..." /><MultiSelect label="Cajas" options={opCajas} selected={filtrosTemp.cajas} onChange={v => setFiltrosTemp({ ...filtrosTemp, cajas: v })} placeholder="Seleccionar..." /></div><div className="flex justify-end gap-2 mt-4 pt-3 border-t border-white/10"><button onClick={limpiarFiltros} className="px-3 py-1.5 bg-white/5 hover:bg-red-500/20 text-white/60 hover:text-red-400 rounded-lg text-xs"><X className="w-3 h-3 inline mr-1" />Limpiar</button><button onClick={aplicarFiltros} className="px-3 py-1.5 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 rounded-lg text-xs font-medium">Aplicar</button></div></div></div>) : null;

  const Dashboard = () => {
    if (loading || !stats) return <div className="flex items-center justify-center h-48"><Loader2 className="w-6 h-6 animate-spin text-orange-500" /><span className="ml-2 text-white/50 text-sm">Cargando...</span></div>;
    const mx = Math.max(...topClientes.map(c => c.ventas), 1);
    return (<div className="space-y-3"><div className="grid grid-cols-5 gap-2"><div className="bg-gradient-to-br from-orange-500/15 to-transparent border border-orange-500/20 rounded-lg p-2.5"><div className="flex items-center gap-1.5 mb-0.5"><DollarSign className="w-3.5 h-3.5 text-orange-400" /><span className="text-white/50 text-[10px]">Ventas ({moneda})</span></div><div className="text-lg font-bold text-white">{fmt(stats.total_ventas)}</div></div><div className="bg-gradient-to-br from-blue-500/15 to-transparent border border-blue-500/20 rounded-lg p-2.5"><div className="flex items-center gap-1.5 mb-0.5"><Truck className="w-3.5 h-3.5 text-blue-400" /><span className="text-white/50 text-[10px]">Viajes</span></div><div className="text-lg font-bold text-white">{fmtN(stats.total_viajes)}</div></div><div className="bg-gradient-to-br from-emerald-500/15 to-transparent border border-emerald-500/20 rounded-lg p-2.5"><div className="flex items-center gap-1.5 mb-0.5"><Globe className="w-3.5 h-3.5 text-emerald-400" /><span className="text-white/50 text-[10px]">IMPEX</span></div><div className="text-base font-bold text-white">{fmt(stats.por_segmento?.IMPEX?.ventas || 0)}</div><div className="text-[9px] text-white/40">{fmtN(stats.por_segmento?.IMPEX?.viajes || 0)} viajes</div></div><div className="bg-gradient-to-br from-purple-500/15 to-transparent border border-purple-500/20 rounded-lg p-2.5"><div className="flex items-center gap-1.5 mb-0.5"><Package className="w-3.5 h-3.5 text-purple-400" /><span className="text-white/50 text-[10px]">DEDICADO</span></div><div className="text-base font-bold text-white">{fmt(stats.por_segmento?.DEDICADO?.ventas || 0)}</div><div className="text-[9px] text-white/40">{fmtN(stats.por_segmento?.DEDICADO?.viajes || 0)} viajes</div></div><div className="bg-gradient-to-br from-cyan-500/15 to-transparent border border-cyan-500/20 rounded-lg p-2.5"><div className="flex items-center gap-1.5 mb-0.5"><Gauge className="w-3.5 h-3.5 text-cyan-400" /><span className="text-white/50 text-[10px]">KMs</span></div><div className="text-base font-bold text-white">{fmtN(Math.round(stats.total_kms))}</div></div></div><div className="grid grid-cols-3 gap-2"><div className="bg-gradient-to-br from-amber-500/15 to-transparent border border-amber-500/20 rounded-lg p-2"><span className="text-amber-400 text-xs">IMPO</span><div className="text-sm font-bold text-white">{fmt(stats.por_tipo?.IMPO?.ventas || 0)}</div><div className="text-[9px] text-white/40">{fmtN(stats.por_tipo?.IMPO?.viajes || 0)} viajes</div></div><div className="bg-gradient-to-br from-teal-500/15 to-transparent border border-teal-500/20 rounded-lg p-2"><span className="text-teal-400 text-xs">EXPO</span><div className="text-sm font-bold text-white">{fmt(stats.por_tipo?.EXPO?.ventas || 0)}</div><div className="text-[9px] text-white/40">{fmtN(stats.por_tipo?.EXPO?.viajes || 0)} viajes</div></div><div className="bg-gradient-to-br from-indigo-500/15 to-transparent border border-indigo-500/20 rounded-lg p-2"><span className="text-indigo-400 text-xs">NAC</span><div className="text-sm font-bold text-white">{fmt(stats.por_tipo?.NAC?.ventas || 0)}</div><div className="text-[9px] text-white/40">{fmtN(stats.por_tipo?.NAC?.viajes || 0)} viajes</div></div></div><div className="grid grid-cols-4 gap-3"><div className="bg-white/[0.02] border border-white/[0.06] rounded-lg p-3"><h3 className="text-xs font-medium text-white mb-2 flex items-center gap-1"><TrendingUp className="w-3 h-3 text-orange-400" />Top Clientes</h3><div className="space-y-1 max-h-44 overflow-y-auto scrollbar-thin scrollbar-thumb-white/10">{topClientes.map((c, i) => (<div key={c.nombre} className="flex items-center gap-1.5"><span className="text-white/30 text-[9px] w-3">{i + 1}</span><div className="flex-1 min-w-0"><div className="flex justify-between items-center"><span className="text-white/70 text-[10px] truncate max-w-[80px]">{c.nombre}</span><span className="text-white/50 text-[9px]">{fmt(c.ventas)}</span></div><div className="h-0.5 bg-white/5 rounded-full overflow-hidden"><div className="h-full bg-orange-500 rounded-full" style={{ width: (c.ventas / mx * 100) + '%' }} /></div></div></div>))}</div></div><div className="bg-white/[0.02] border border-white/[0.06] rounded-lg p-3"><h3 className="text-xs font-medium text-white mb-2 flex items-center gap-1"><Building2 className="w-3 h-3 text-blue-400" />Por Empresa</h3><div className="space-y-1.5">{Object.entries(stats.por_empresa || {}).map(([e, d]) => { const mxE = Math.max(...Object.values(stats.por_empresa || {}).map(x => x.ventas), 1); const colors: Record<string, string> = { TROB: 'bg-orange-500', WE: 'bg-blue-500', SHI: 'bg-emerald-500', TROB_USA: 'bg-purple-500' }; return <div key={e}><div className="flex justify-between items-center"><span className="text-white text-[10px]">{e}</span><span className="text-white/50 text-[9px]">{fmt(d.ventas)}</span></div><div className="h-1.5 bg-white/5 rounded-full overflow-hidden"><div className={(colors[e] || 'bg-gray-500') + ' h-full rounded-full'} style={{ width: (d.ventas / mxE * 100) + '%' }} /></div></div>; })}</div></div><div className="bg-white/[0.02] border border-white/[0.06] rounded-lg p-3"><h3 className="text-xs font-medium text-white mb-2 flex items-center gap-1"><Truck className="w-3 h-3 text-cyan-400" />Top Tractos</h3><div className="space-y-1 max-h-44 overflow-y-auto scrollbar-thin scrollbar-thumb-white/10">{topTractos.slice(0, 8).map((t, i) => { const mxT = Math.max(...topTractos.map(x => x.ventas), 1); return <div key={t.nombre} className="flex items-center gap-1.5"><span className="text-white/30 text-[9px] w-3">{i + 1}</span><div className="flex-1"><div className="flex justify-between"><span className="text-white/70 text-[10px] font-mono">#{t.nombre}</span><span className="text-white/50 text-[9px]">{fmtN(t.viajes)}</span></div><div className="h-0.5 bg-white/5 rounded-full"><div className="h-full bg-cyan-500 rounded-full" style={{ width: (t.ventas / mxT * 100) + '%' }} /></div></div></div>; })}</div></div><div className="bg-white/[0.02] border border-white/[0.06] rounded-lg p-3"><h3 className="text-xs font-medium text-white mb-2 flex items-center gap-1"><Package className="w-3 h-3 text-purple-400" />Top Cajas</h3><div className="space-y-1 max-h-44 overflow-y-auto scrollbar-thin scrollbar-thumb-white/10">{topCajas.slice(0, 8).map((c, i) => { const mxC = Math.max(...topCajas.map(x => x.ventas), 1); return <div key={c.nombre} className="flex items-center gap-1.5"><span className="text-white/30 text-[9px] w-3">{i + 1}</span><div className="flex-1"><div className="flex justify-between"><span className="text-white/70 text-[10px] font-mono">#{c.nombre}</span><span className="text-white/50 text-[9px]">{fmtN(c.viajes)}</span></div><div className="h-0.5 bg-white/5 rounded-full"><div className="h-full bg-purple-500 rounded-full" style={{ width: (c.ventas / mxC * 100) + '%' }} /></div></div></div>; })}</div></div></div><div className="bg-white/[0.02] border border-white/[0.06] rounded-lg p-3"><h3 className="text-xs font-medium text-white mb-2 flex items-center gap-1"><BarChart3 className="w-3 h-3 text-orange-400" />Ventas {yearAplicado}</h3><div className="flex items-end gap-1 h-28">{MES.map((m, i) => { const k = yearAplicado + '-' + String(i + 1).padStart(2, '0'); const d = datosMensuales[k] || { ventas: 0 }; const mxM = Math.max(...Object.values(datosMensuales).map(x => x.ventas), 1); const h = mxM > 0 ? (d.ventas / mxM) * 100 : 0; return (<div key={m} className="flex-1 flex flex-col items-center group"><div className="w-full flex flex-col items-center justify-end h-20 relative"><div className="absolute -top-5 opacity-0 group-hover:opacity-100 transition-opacity bg-black/80 text-white text-[8px] px-1 py-0.5 rounded whitespace-nowrap z-10">{fmt(d.ventas)}</div><div className="w-full bg-gradient-to-t from-orange-500 to-orange-400 rounded-t" style={{ height: h + '%', minHeight: d.ventas > 0 ? '2px' : '0' }} /></div><span className="text-white/30 text-[8px] mt-1">{m}</span></div>); })}</div></div></div>);
  };

  const Chat = () => (<div className="h-[400px] flex flex-col bg-white/[0.02] border border-white/[0.06] rounded-lg"><div className="p-2 border-b border-white/[0.06] flex items-center gap-2"><Sparkles className="w-3 h-3 text-orange-400" /><span className="text-white text-xs font-medium">Análisis IA</span></div><div className="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin scrollbar-thumb-white/10">{chatMsgs.length === 0 && <div className="text-center text-white/30 py-4"><Bot className="w-6 h-6 mx-auto mb-1 opacity-50" /><p className="text-[10px]">Pregunta sobre ventas</p></div>}{chatMsgs.map((m, i) => <div key={i} className={'flex ' + (m.role === 'user' ? 'justify-end' : 'justify-start')}><div className={'max-w-[80%] p-2 rounded-lg text-[10px] ' + (m.role === 'user' ? 'bg-orange-500/20 text-white' : 'bg-white/5 text-white/80')}>{m.content}</div></div>)}{chatLoad && <div className="flex justify-start"><div className="bg-white/5 rounded-lg p-2 flex items-center gap-1"><Loader2 className="w-3 h-3 animate-spin" /><span className="text-[10px] text-white/50">...</span></div></div>}</div><div className="p-2 border-t border-white/[0.06] flex gap-1"><input type="text" value={chatIn} onChange={e => setChatIn(e.target.value)} onKeyDown={e => e.key === 'Enter' && enviarChat()} placeholder="Pregunta..." className="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1 text-white text-[10px] placeholder-white/30" /><button onClick={enviarChat} disabled={chatLoad || !chatIn.trim()} className="px-2 py-1 bg-orange-500/20 rounded text-orange-400 disabled:opacity-50"><Send className="w-3 h-3" /></button></div></div>);

  return (<ModuleTemplate title="Ventas" subtitle={userPermisos.vendedor ? 'Vendedor: ' + userPermisos.vendedor : 'Grupo Loma & TROB USA'} icon={TrendingUp} accentColor="orange" backgroundImage={MODULE_IMAGES.ventas} onBack={onBack}><ModalFiltros /><div className="flex items-center justify-between mb-2"><div className="flex gap-1"><button onClick={() => setVista('dashboard')} className={'px-2 py-1 rounded text-[10px] font-medium flex items-center gap-1 ' + (vista === 'dashboard' ? 'bg-orange-500/20 text-orange-400' : 'bg-white/5 text-white/50')}><BarChart3 className="w-3 h-3" />Dashboard</button><button onClick={() => setVista('chat')} className={'px-2 py-1 rounded text-[10px] font-medium flex items-center gap-1 ' + (vista === 'chat' ? 'bg-orange-500/20 text-orange-400' : 'bg-white/5 text-white/50')}><Sparkles className="w-3 h-3" />IA</button></div><div className="flex items-center gap-1.5"><span className="text-white/40 text-[10px]">{yearAplicado}</span><button onClick={abrirFiltros} className={'flex items-center gap-1 px-2 py-1 rounded text-[10px] ' + (nFiltros ? 'bg-orange-500/20 text-orange-400' : 'bg-white/5 text-white/50')}><Filter className="w-3 h-3" />Filtros{nFiltros > 0 && <span className="bg-orange-500 text-white text-[8px] px-1 rounded-full">{nFiltros}</span>}</button><button onClick={cargarDatos} className="p-1 bg-white/5 hover:bg-white/10 rounded"><RefreshCw className="w-3 h-3 text-white/50" /></button><span className="text-[9px] text-white/30 flex items-center gap-0.5"><span className="w-1 h-1 rounded-full bg-emerald-500" />{ultimaAct}</span></div></div>{vista === 'dashboard' ? <Dashboard /> : <Chat />}</ModuleTemplate>);
}

export default VentasModule;
