import { ModuleTemplate } from './ModuleTemplate';
import { useState, useEffect } from 'react';
import { Search, Download, TrendingUp, X, BarChart3, Building2, User, Calendar, Eye, Trash2, SortAsc, SortDesc, FileText, Upload, Pencil, AlertTriangle, Loader2, CheckCircle, DollarSign, Clock, Zap, Flame, Skull, MapPin, ArrowRight, Truck } from 'lucide-react';
import { projectId, publicAnonKey } from '../../utils/supabase/info';
import * as pdfjsLib from 'pdfjs-dist';

pdfjsLib.GlobalWorkerOptions.workerSrc = `//cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;

interface PanelOportunidadesModuleProps { onBack: () => void; }
interface LineaCotizacion { origen: string; destino: string; servicio: string; tarifa: number; moneda: string; viajes: number; tipoViaje: string; subtotalMXN: number; }
interface Cotizacion { nombre: string; url: string; fecha: string; analisis?: any; eliminado?: boolean; lineas?: LineaCotizacion[]; potencialMXN?: number; }
interface HistorialCambio { fecha: string; campo: string; valorAnterior: string; valorNuevo: string; usuario: string; }
interface Lead { id: string; nombreEmpresa: string; paginaWeb: string; nombreContacto: string; telefonoContacto?: string; correoElectronico: string; tipoServicio: string[]; tipoViaje: string[]; principalesRutas: string; viajesPorMes: string; tarifa: string; proyectadoVentaMensual?: string; proximosPasos: string; etapaLead?: string; altaCliente?: boolean; generacionSOP?: boolean; juntaArranque?: boolean; facturado?: boolean; vendedor: string; fechaCaptura?: string; fechaActualizacion?: string; cotizaciones?: Cotizacion[]; eliminado?: boolean; fechaEliminado?: string; historial?: HistorialCambio[]; fechaLiberacion?: string; }
type SortField = 'nombreEmpresa' | 'vendedor' | 'fechaCaptura' | 'viajesPorMes';
type SortDirection = 'asc' | 'desc';

const CLIENTES_EXISTENTES = ['ABASTECEDORA DE MATERIAS PRIMAS','AGROINDUSTRIAL AGRILEG DE TEHUACAN','AGROPECUARIA MARLEE','AGROS','ALIANZA CARNICA','ALIMENTOS FINOS DE OCCIDENTE','ALIMENTOS Y SAZONADORES REGIOS','ALL CARRIERS, INC.','ARCBEST II INC','ARCH MEAT','ATLAS EXPEDITORS','AVICOLA PILGRIM\'S PRIDE DE MEXICO','BAKERY MACHINERY AND ENGINEERING LLC','BARCEL','BARRY CALLEBAUT MEXICO','BBA LOGISTCS LLC','BERRIES PARADISE','BIMBO','BISON TRANSPORT INC','C H ROBINSON DE MEXICO','CADENA COMERCIAL OXXO','CARNES SELECTAS TANGAMANGA','CAROLINA LOGISTICS INC','CFI LOGISTICA','CH ROBINSON WORLDWIDE, INC','COMERCIALIZADORA DE LACTEOS Y DERIVADOS','COMERCIALIZADORA GAB','COMERCIALIZADORA KEES','DEACERO','DISTRIBUCION Y EMBARQUES FRESH','EA LOGISTICA','EMPACADORA DE CARNES UNIDAD GANADERA','ENLACES TERRESTRES DEL BOSQUE','FRIGORIFICO Y EMPACADORA DE AGUASCALIENTES','FWD LOGISTICA','GANADEROS PRODUCTORES DE LECHE PURA','GRANJAS CARROLL DE MEXICO','GRANJERO FELIZ','GRUPO MELANGE DE MEXICO','HEXPOL COMPOUNDING','HIGH TECH FARMS','HONDA TRADING DE MEXICO','HORTIFRUT','IMPORTADORA DE PRODUCTOS CARNICOS APODACA','INDUSTRIALIZADORA DE CARNICOS STRATTEGA','INDUSTRIAS ACROS WHIRLPOOL','INTERCARNES','INTERLAND TRANSPORT','INTERLAND USA','JOHNSON CONTROLS ENTERPRISES MEXICO','KGL INTERNATIONAL NETWORK MEXICO','KONEKT INTERSERVICE','KRONUS LOGISTICS LLC','LOGISTEED MEXICO','LONGHORN WAREHOUSES, INC','MAR BRAN','MARBRAN USA, LTD','MARTICO MEX','MCALLEN MEAT PURVEYORS, LLC','MCCAIN MEXICO','NATURESWEET COMERCIALIZADORA','NATURESWEET INVERNADEROS','NS BRANDS, LTD','NUVOCARGO','ONE SOLUTION GROUP, INC','P.A.C. INTERNATIONAL','PERFORMER LOGISTICS','PILGRIM\'S PRIDE','PIPER TRADING LLC','POLLO Y HUEVO TRIUNFO','PRODUCTORA AGRICOLA DE AGUASCALIENTES','PRODUCTORA DE BOCADOS CARNICOS','PRODUCTOS CAREY','PRODUCTOS FRUGO','PROMOTORA DE MERCADOS','R.H. SHIPPING & CHARTERING','RANCHO ACUICOLA ELIXIR','RED ROAD LOGISTICS INC','SCHENKER INTERNATIONAL','SERVI CARNES DE OCCIDENTE','SIGMA ALIMENTOS CENTRO','SIGMA ALIMENTOS COMERCIAL','SPEEDYHAUL INTERNATIONAL','STEERINGMEX','SUMMIT PLASTICS GUANAJUATO','SUN CHEMICAL','TEU LOGISTICA','TITAN MEATS LLC','TRANSPLACE MEXICO LLC','TRAXION TECHNOLOGIES','TROB TRANSPORTES','TROB USA, LLC','UNITED FC DE MEXICO','VALLE REDONDO','VDT LOGISTICA','VEGGIE PRIME','VICTUX','VISCERAS SELECTAS DEL BAJIO','WEXPRESS','WHIRLPOOL INTERNACIONAL','ZEBRA LOGISTICS','ZEBRA LOGISTICS, INC'];

const formatDate = (dateStr: string | undefined): string => { if (!dateStr) return '-'; try { const date = new Date(dateStr); if (isNaN(date.getTime())) return '-'; return date.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch { return '-'; } };
const formatDateTime = (dateStr: string | undefined): string => { if (!dateStr) return '-'; try { const date = new Date(dateStr); if (isNaN(date.getTime())) return '-'; return date.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch { return '-'; } };
const diasSinMovimiento = (fechaActualizacion: string | undefined, fechaCaptura: string | undefined): number => { const fecha = fechaActualizacion || fechaCaptura; if (!fecha) return 0; return Math.floor((Date.now() - new Date(fecha).getTime()) / (1000 * 60 * 60 * 24)); };
const diasDesdeCreacion = (fechaCaptura: string | undefined): number => { if (!fechaCaptura) return 0; return Math.floor((Date.now() - new Date(fechaCaptura).getTime()) / (1000 * 60 * 60 * 24)); };

const esUbicacionUSA = (ubicacion: string): boolean => { const lower = ubicacion.toLowerCase(); const estadosUSA = ['tx', 'texas', 'ca', 'california', 'az', 'arizona', 'nm', 'new mexico', 'illinois', 'il', 'ohio', 'oh', 'michigan', 'mi']; const ciudadesUSA = ['laredo', 'dallas', 'houston', 'san antonio', 'mcallen', 'brownsville', 'eagle pass', 'el paso', 'austin', 'chicago', 'los angeles', 'phoenix', 'tucson', 'tyler', 'edinburg']; const tieneZipUSA = /\b\d{5}\b/.test(ubicacion); return estadosUSA.some(e => lower.includes(e)) || ciudadesUSA.some(c => lower.includes(c)) || tieneZipUSA; };
const esFronteraMX = (ubicacion: string): boolean => { const lower = ubicacion.toLowerCase(); return lower.includes('nuevo laredo') || lower.includes('nvo laredo') || lower.includes('reynosa') || lower.includes('matamoros') || (lower.includes('nogales') && !lower.includes('az')) || lower.includes('tijuana') || lower.includes('mexicali') || lower.includes('ciudad juarez') || lower.includes('piedras negras') || (lower.includes('colombia') && lower.includes('nl')); };
const detectarTipoViaje = (origen: string, destino: string, servicio: string): string => { const origenUSA = esUbicacionUSA(origen); const destinoUSA = esUbicacionUSA(destino); const destinoFronteraMX = esFronteraMX(destino); const servicioLower = servicio.toLowerCase(); if (servicioLower.includes('parte americana') || servicioLower.includes('americana')) return 'DTD'; if (origenUSA && destinoUSA) return 'DTD'; if (origenUSA && !destinoUSA) return 'Impo'; if (!origenUSA && destinoUSA) return 'Expo'; if (!origenUSA && destinoFronteraMX) return 'Expo'; return 'Nacional'; };
const normalizarServicio = (servicio: string): string => { const lower = servicio.toLowerCase(); if (lower.includes('refrigerado') || lower.includes('thermo') || lower.includes('reefer')) return 'Refrigerado'; if (lower.includes('hazmat')) return lower.includes('refri') ? 'Refrigerado Hazmat' : 'Seco Hazmat'; return 'Seco'; };

const parsearCotizacionPDF = (texto: string): LineaCotizacion[] => { const lineas: LineaCotizacion[] = []; const lines = texto.split('\n').map(l => l.trim()).filter(l => l); let i = 0; while (i < lines.length) { const line = lines[i]; if (line.toLowerCase().includes('origen') && line.toLowerCase().includes('destino') && line.toLowerCase().includes('importe')) { i++; let origen = '', destino = '', servicio = '', importe = 0, moneda = 'MXN'; while (i < lines.length && !lines[i].toLowerCase().startsWith('total') && !(lines[i].toLowerCase().includes('origen') && lines[i].toLowerCase().includes('destino') && lines[i].toLowerCase().includes('importe'))) { const dataLine = lines[i].trim(); const importeMatch = dataLine.match(/([\d,]+\.?\d*)\s*(USD|MXN|\$MX)/i); if (importeMatch) { importe = parseFloat(importeMatch[1].replace(/,/g, '')); moneda = importeMatch[2].toUpperCase().includes('USD') ? 'USD' : 'MXN'; } const servicioMatch = dataLine.match(/(Refrigerado|Seco|Parte Americana|Cruce|Hazmat)/i); if (servicioMatch) servicio = servicioMatch[1]; if (!origen && !importeMatch && dataLine.length > 3) { if (/[A-Za-z]+.*[,.]/.test(dataLine) || /\b(TX|CA|AZ|NL|Jal|Ags|Coah|Tamps|Gto|Qro)\b/i.test(dataLine)) { origen = dataLine.replace(/-$/, '').trim(); } } else if (origen && !destino && !importeMatch && !servicioMatch && dataLine.length > 3) { if (/[A-Za-z]+.*[,.]/.test(dataLine) || /\b(TX|CA|AZ|NL|Jal|Ags|Coah|Tamps|Gto|Qro)\b/i.test(dataLine)) { destino = dataLine.replace(/-$/, '').trim(); } } i++; } if (origen && destino && importe > 0) { lineas.push({ origen: origen.replace(/\s+/g, ' ').trim(), destino: destino.replace(/\s+/g, ' ').trim(), servicio: normalizarServicio(servicio) || 'Seco', tarifa: importe, moneda, viajes: 0, tipoViaje: detectarTipoViaje(origen, destino, servicio), subtotalMXN: 0 }); } } else { i++; } } return lineas; };

const analizarPDFConClaude = async (textoPDF: string, pdfBase64?: string): Promise<LineaCotizacion[]> => { try { let imagenBase64 = ''; if (pdfBase64) { try { const base64Data = pdfBase64.split(',')[1] || pdfBase64; const binaryString = atob(base64Data); const bytes = new Uint8Array(binaryString.length); for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i); const pdf = await pdfjsLib.getDocument({ data: bytes }).promise; const page = await pdf.getPage(1); const scale = 2; const viewport = page.getViewport({ scale }); const canvas = document.createElement('canvas'); canvas.width = viewport.width; canvas.height = viewport.height; const ctx = canvas.getContext('2d'); await page.render({ canvasContext: ctx!, viewport }).promise; imagenBase64 = canvas.toDataURL('image/png'); } catch (e) { console.error('Error convirtiendo PDF:', e); } } const response = await fetch(`https://fbxbsslhewchyibdoyzk.supabase.co/functions/v1/analizar-cotizacion-pdf`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${publicAnonKey}` }, body: JSON.stringify({ imagenBase64, textoPDF }) }); if (!response.ok) return []; const data = await response.json(); if (!data.success || !data.rutas || data.rutas.length === 0) return []; return data.rutas.map((r: any) => ({ origen: r.origen || '', destino: r.destino || '', servicio: r.servicio || 'Seco', tarifa: parseFloat(r.tarifa) || 0, moneda: r.moneda || 'MXN', viajes: 0, tipoViaje: detectarTipoViaje(r.origen || '', r.destino || '', r.servicio || ''), subtotalMXN: 0 })); } catch { return []; } };

const extraerTextoPDF = async (base64: string): Promise<string> => { try { const base64Data = base64.split(',')[1] || base64; const binaryString = atob(base64Data); const bytes = new Uint8Array(binaryString.length); for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i); const pdf = await pdfjsLib.getDocument({ data: bytes }).promise; let fullText = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); fullText += textContent.items.map((item: any) => item.str).join(' ') + '\n'; } return fullText; } catch { return ''; } };
const obtenerTipoCambio = async (): Promise<number> => { try { const cached = localStorage.getItem('tipoCambioUSD'); if (cached) { const { valor, fecha } = JSON.parse(cached); if (fecha === new Date().toISOString().split('T')[0]) return valor; } const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD'); if (response.ok) { const data = await response.json(); const tc = data.rates?.MXN || 18.5; localStorage.setItem('tipoCambioUSD', JSON.stringify({ valor: tc, fecha: new Date().toISOString().split('T')[0] })); return tc; } return 18.5; } catch { return 18.5; } };
const calcularPotencialDesdeCotizaciones = (lead: Lead): number => { if (!lead.cotizaciones) return 0; return lead.cotizaciones.filter(c => !c.eliminado && c.potencialMXN).reduce((sum, c) => sum + (c.potencialMXN || 0), 0); };
const buscarDuplicados = (nombre: string, leadsExistentes: Lead[]): { duplicadoExacto: boolean; similares: string[] } => { const nombreNorm = nombre.toUpperCase().trim(); const duplicadoExacto = CLIENTES_EXISTENTES.some(c => c.toUpperCase() === nombreNorm) || leadsExistentes.some(l => l.nombreEmpresa.toUpperCase() === nombreNorm); const similares: string[] = []; const palabras = nombreNorm.split(' ').filter(p => p.length > 3); CLIENTES_EXISTENTES.forEach(c => { const cNorm = c.toUpperCase(); if (cNorm !== nombreNorm && palabras.some(p => cNorm.includes(p))) similares.push(c); }); leadsExistentes.forEach(l => { const lNorm = l.nombreEmpresa.toUpperCase(); if (lNorm !== nombreNorm && palabras.some(p => lNorm.includes(p)) && !similares.includes(l.nombreEmpresa)) similares.push(l.nombreEmpresa); }); return { duplicadoExacto, similares: similares.slice(0, 5) }; };

export const PanelOportunidadesModule = ({ onBack }: PanelOportunidadesModuleProps) => {
  const [leads, setLeads] = useState<Lead[]>([]);
  const [filteredLeads, setFilteredLeads] = useState<Lead[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterVendedor, setFilterVendedor] = useState('');
  const [filterFecha, setFilterFecha] = useState('');
  const [sortField, setSortField] = useState<SortField>('fechaCaptura');
  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');
  const [showFunnel, setShowFunnel] = useState(false);
  const [selectedLead, setSelectedLead] = useState<Lead | null>(null);
  const [cotizacionesModal, setCotizacionesModal] = useState<Lead | null>(null);
  const [editLead, setEditLead] = useState<Lead | null>(null);
  const [formData, setFormData] = useState<Partial<Lead>>({});
  const [deleteModal, setDeleteModal] = useState<Lead | null>(null);
  const [deleteConfirmText, setDeleteConfirmText] = useState('');
  const [isAdmin, setIsAdmin] = useState(false);
  const [showDeleted, setShowDeleted] = useState(false);
  const [analizando, setAnalizando] = useState(false);
  const [statusMsg, setStatusMsg] = useState('');
  const [pdfPreview, setPdfPreview] = useState<string | null>(null);
  const [tipoCambio, setTipoCambio] = useState<number>(18.5);
  const [lineasModal, setLineasModal] = useState<{cotizacion: Cotizacion, lead: Lead, index: number} | null>(null);
  const [lineasCotizacion, setLineasCotizacion] = useState<LineaCotizacion[]>([]);

  useEffect(() => { obtenerTipoCambio().then(tc => setTipoCambio(tc)); }, []);
  useEffect(() => { if (editLead) setFormData(editLead); }, [editLead]);

  useEffect(() => { const cargarLeads = async () => { try { const session = localStorage.getItem('fx27-session'); let vendedorActual = '', esAdmin = false; if (session) { const { email } = JSON.parse(session); const usuarios = JSON.parse(localStorage.getItem('fx27-usuarios') || '[]'); const usuario = usuarios.find((u: any) => u.correo === email); if (usuario) { vendedorActual = usuario.nombre; esAdmin = usuario.rol === 'admin'; setIsAdmin(esAdmin); } } const url = esAdmin ? `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads` : `https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads?vendedor=${encodeURIComponent(vendedorActual)}`; const response = await fetch(url, { headers: { 'Authorization': `Bearer ${publicAnonKey}` } }); const result = await response.json(); if (response.ok && result.success) { setLeads(result.leads); setFilteredLeads(result.leads.filter((l: Lead) => !l.eliminado)); } } catch (error) { console.error('Error:', error); } }; cargarLeads(); }, []);

  useEffect(() => { let resultado = [...leads]; if (!showDeleted) resultado = resultado.filter(lead => !lead.eliminado); if (searchTerm) resultado = resultado.filter(lead => lead.nombreEmpresa.toLowerCase().includes(searchTerm.toLowerCase()) || lead.nombreContacto.toLowerCase().includes(searchTerm.toLowerCase()) || lead.correoElectronico.toLowerCase().includes(searchTerm.toLowerCase())); if (filterVendedor) resultado = resultado.filter(lead => lead.vendedor === filterVendedor); if (filterFecha) resultado = resultado.filter(lead => { try { return lead.fechaCaptura && new Date(lead.fechaCaptura).toISOString().split('T')[0] === filterFecha; } catch { return false; } }); resultado.sort((a, b) => { let valueA: any = a[sortField], valueB: any = b[sortField]; if (sortField === 'viajesPorMes') { valueA = parseInt(valueA) || 0; valueB = parseInt(valueB) || 0; } if (sortField === 'fechaCaptura') { try { valueA = new Date(a.fechaCaptura || '').getTime() || 0; valueB = new Date(b.fechaCaptura || '').getTime() || 0; } catch { valueA = 0; valueB = 0; } } if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1; if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1; return 0; }); setFilteredLeads(resultado); }, [leads, searchTerm, filterVendedor, filterFecha, sortField, sortDirection, showDeleted]);

  const getAlertaLead = (lead: Lead): { tipo: 'amarillo' | 'rojo' | 'critico' | null; mensaje: string; dias: number } => { if (lead.etapaLead === 'Cerrado') return { tipo: null, mensaje: '', dias: 0 }; const diasCreacion = diasDesdeCreacion(lead.fechaCaptura); const diasSinMov = diasSinMovimiento(lead.fechaActualizacion, lead.fechaCaptura); if (diasCreacion >= 90) { const diasRestantes = 15 - (diasCreacion - 90); return { tipo: 'critico', mensaje: `Lead serÃ¡ liberado en ${diasRestantes > 0 ? diasRestantes : 0} dÃ­as.`, dias: diasRestantes > 0 ? diasRestantes : 0 }; } if (diasSinMov >= 30) return { tipo: 'rojo', mensaje: `${diasSinMov} dÃ­as sin movimiento. Â¡Urge!`, dias: diasSinMov }; if (diasSinMov >= 15) return { tipo: 'amarillo', mensaje: `${diasSinMov} dÃ­as sin movimiento.`, dias: diasSinMov }; return { tipo: null, mensaje: '', dias: 0 }; };

  const handleSort = (field: SortField) => { if (sortField === field) setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc'); else { setSortField(field); setSortDirection('asc'); } };
  const handleExportExcel = () => { const headers = ['Empresa', 'Contacto', 'Email', 'Servicio', 'Viaje', 'Rutas', 'Viajes/Mes', 'Potencial MXN', 'Vendedor', 'Fecha']; const rows = filteredLeads.map(lead => { const potencial = calcularPotencialDesdeCotizaciones(lead); return [lead.nombreEmpresa, lead.nombreContacto, lead.correoElectronico, (lead.tipoServicio||[]).join(', '), (lead.tipoViaje||[]).join(', '), lead.principalesRutas, lead.viajesPorMes, potencial > 0 ? `$${potencial.toLocaleString('es-MX')}` : '', lead.vendedor, formatDate(lead.fechaCaptura)]; }); const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `leads_fx27_${new Date().toISOString().split('T')[0]}.csv`; link.click(); };
  const getVendedoresUnicos = () => Array.from(new Set(leads.map(lead => lead.vendedor)));

  const handleSubirCotizaciones = async (files: FileList, lead: Lead) => { setAnalizando(true); setStatusMsg('Leyendo PDF...'); const archivos = Array.from(files).filter(f => f.type === 'application/pdf'); if (archivos.length === 0) { alert('Solo PDFs'); setAnalizando(false); setStatusMsg(''); return; } for (const file of archivos) { try { setStatusMsg('Extrayendo contenido...'); const base64 = await new Promise<string>((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result as string); reader.onerror = () => reject('Error'); reader.readAsDataURL(file); }); setStatusMsg('Extrayendo texto...'); const textoPDF = await extraerTextoPDF(base64); setStatusMsg('ðŸ¤– Analizando con IA...'); let rutas = await analizarPDFConClaude(textoPDF, base64); if (rutas.length === 0) { rutas = parsearCotizacionPDF(textoPDF); } if (rutas.length === 0) { rutas.push({ origen: '', destino: '', servicio: 'Seco', tarifa: 0, moneda: 'USD', viajes: 0, tipoViaje: 'Nacional', subtotalMXN: 0 }); } const nuevaCot: Cotizacion = { nombre: file.name, url: base64, fecha: new Date().toISOString(), eliminado: false }; const leadTemp = { ...lead, cotizaciones: [...(lead.cotizaciones || []), nuevaCot] }; setLeads(leads.map(l => l.id === lead.id ? leadTemp : l)); setCotizacionesModal(leadTemp); setLineasCotizacion(rutas); setLineasModal({ cotizacion: nuevaCot, lead: leadTemp, index: (lead.cotizaciones || []).length }); setAnalizando(false); setStatusMsg(''); return; } catch (e) { console.error('Error:', e); alert('Error al procesar'); } } setAnalizando(false); setStatusMsg(''); };

  const calcularSubtotal = (linea: LineaCotizacion): number => { const tarifaMXN = linea.moneda === 'USD' ? linea.tarifa * tipoCambio : linea.tarifa; return linea.viajes * tarifaMXN; };
  const calcularTotalMXN = (): number => lineasCotizacion.reduce((sum, linea) => sum + calcularSubtotal(linea), 0);
  const todosViajesCapturados = (): boolean => lineasCotizacion.every(l => l.viajes > 0 && l.origen && l.destino && l.tarifa > 0);
  const handleCambioLinea = (idx: number, campo: keyof LineaCotizacion, valor: any) => { const arr = [...lineasCotizacion]; (arr[idx] as any)[campo] = valor; if (campo === 'origen' || campo === 'destino') arr[idx].tipoViaje = detectarTipoViaje(arr[idx].origen, arr[idx].destino, arr[idx].servicio); setLineasCotizacion(arr); };

  const handleGuardarCotizacion = async () => { if (!lineasModal || !todosViajesCapturados()) return; const { lead, index } = lineasModal; const cotizaciones = [...(lead.cotizaciones || [])]; const lineasConSubtotal = lineasCotizacion.map(l => ({ ...l, subtotalMXN: calcularSubtotal(l) })); const potencialMXN = calcularTotalMXN(); cotizaciones[index] = { ...cotizaciones[index], lineas: lineasConSubtotal, potencialMXN }; const tiposViaje = [...(lead.tipoViaje || [])]; const tiposServicio = [...(lead.tipoServicio || [])]; let rutas = lead.principalesRutas || ''; let totalViajes = parseInt(lead.viajesPorMes || '0'); lineasConSubtotal.forEach(l => { if (l.tipoViaje && !tiposViaje.includes(l.tipoViaje)) tiposViaje.push(l.tipoViaje); if (l.servicio && !tiposServicio.includes(l.servicio)) tiposServicio.push(l.servicio); const rutaStr = `${l.origen} â†’ ${l.destino}`; if (!rutas.includes(rutaStr)) rutas = rutas ? `${rutas}, ${rutaStr}` : rutaStr; totalViajes += l.viajes; }); let potencialTotal = 0; cotizaciones.forEach(cot => { if (!cot.eliminado && cot.potencialMXN) potencialTotal += cot.potencialMXN; }); const historialNuevo: HistorialCambio = { fecha: new Date().toISOString(), campo: 'cotizaciones', valorAnterior: '', valorNuevo: `Nueva cotizaciÃ³n: ${cotizaciones[index].nombre}`, usuario: lead.vendedor }; const leadActualizado = { ...lead, cotizaciones, tipoViaje: tiposViaje, tipoServicio: tiposServicio, principalesRutas: rutas, viajesPorMes: String(totalViajes), proyectadoVentaMensual: potencialTotal > 0 ? `$${potencialTotal.toLocaleString('es-MX')} MXN` : '', etapaLead: 'Cotizado', fechaActualizacion: new Date().toISOString(), historial: [...(lead.historial || []), historialNuevo] }; try { await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === lead.id ? leadActualizado : l)); setCotizacionesModal(leadActualizado); setLineasModal(null); setLineasCotizacion([]); alert('CotizaciÃ³n guardada'); } catch { alert('Error'); } };

  const handleEliminarCotizacion = async (lead: Lead, index: number) => { const cotizaciones = lead.cotizaciones?.map((c, i) => i === index ? { ...c, eliminado: true } : c) || []; const potencialTotal = cotizaciones.filter(c => !c.eliminado && c.potencialMXN).reduce((sum, c) => sum + (c.potencialMXN || 0), 0); const leadActualizado = { ...lead, cotizaciones, proyectadoVentaMensual: potencialTotal > 0 ? `$${potencialTotal.toLocaleString('es-MX')} MXN` : '', fechaActualizacion: new Date().toISOString() }; try { await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === lead.id ? leadActualizado : l)); setCotizacionesModal(leadActualizado); } catch { alert('Error'); } };
  const handleConfirmarEliminacion = async () => { if (!deleteModal || deleteConfirmText !== 'DELETE') return; try { const leadActualizado = { ...deleteModal, eliminado: true, fechaEliminado: new Date().toISOString() }; await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${deleteModal.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === deleteModal.id ? leadActualizado : l)); setDeleteModal(null); setDeleteConfirmText(''); } catch { alert('Error'); } };
  const handleRestaurarLead = async (lead: Lead) => { if (!isAdmin) return; try { const leadActualizado = { ...lead, eliminado: false, fechaEliminado: null }; await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${lead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === lead.id ? leadActualizado : l)); } catch {} };

  const handleGuardarEdicion = async () => { if (!editLead || !formData?.nombreEmpresa?.trim() || !formData?.nombreContacto?.trim() || !formData?.correoElectronico?.trim()) { alert('Campos obligatorios'); return; } const { duplicadoExacto, similares } = buscarDuplicados(formData.nombreEmpresa || '', leads.filter(l => l.id !== editLead.id)); if (duplicadoExacto) { alert(`Error: "${formData.nombreEmpresa}" ya existe.`); return; } if (similares.length > 0 && !confirm(`Similares:\n${similares.join('\n')}\n\nÂ¿Continuar?`)) return; try { const historialNuevo: HistorialCambio = { fecha: new Date().toISOString(), campo: 'ediciÃ³n', valorAnterior: editLead.nombreEmpresa, valorNuevo: formData.nombreEmpresa || '', usuario: editLead.vendedor }; const leadActualizado = { ...editLead, ...formData, tipoServicio: formData.tipoServicio || [], tipoViaje: formData.tipoViaje || [], fechaActualizacion: new Date().toISOString(), historial: [...(editLead.historial || []), historialNuevo] }; await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-d84b50bb/leads/${editLead.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${publicAnonKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify(leadActualizado) }); setLeads(leads.map(l => l.id === editLead.id ? leadActualizado : l)); setEditLead(null); setFormData({}); } catch { alert('Error'); } };

  const handleInputChange = (field: keyof Lead, value: any) => { if (field === 'nombreContacto') setFormData({ ...formData, [field]: value.toLowerCase().split(' ').map((p: string) => p.charAt(0).toUpperCase() + p.slice(1)).join(' ') }); else if (field === 'correoElectronico') setFormData({ ...formData, [field]: value.toLowerCase() }); else setFormData({ ...formData, [field]: value }); };
  const handleToggleServicio = (s: string) => { const arr = formData.tipoServicio || []; setFormData({ ...formData, tipoServicio: arr.includes(s) ? arr.filter(x => x !== s) : [...arr, s] }); };
  const handleToggleViaje = (v: string) => { const arr = formData.tipoViaje || []; setFormData({ ...formData, tipoViaje: arr.includes(v) ? arr.filter(x => x !== v) : [...arr, v] }); };
  const SortIcon = ({ field }: { field: SortField }) => sortField !== field ? <SortAsc className="w-4 h-4 opacity-30" /> : sortDirection === 'asc' ? <SortAsc className="w-4 h-4" /> : <SortDesc className="w-4 h-4" />;
  const AlertBadge = ({ lead }: { lead: Lead }) => { const alerta = getAlertaLead(lead); if (!alerta.tipo) return null; const base = "inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium cursor-help shadow-[0_2px_8px_rgba(0,0,0,0.25)]"; if (alerta.tipo === 'amarillo') return <span title={alerta.mensaje} className={`${base} bg-amber-500/[0.12] text-amber-400/90 border border-amber-500/[0.20]`}><Zap className="w-3 h-3" />{alerta.dias}d</span>; if (alerta.tipo === 'rojo') return <span title={alerta.mensaje} className={`${base} bg-red-500/[0.12] text-red-400/90 border border-red-500/[0.20] animate-pulse`}><Flame className="w-3 h-3" />{alerta.dias}d</span>; if (alerta.tipo === 'critico') return <span title={alerta.mensaje} className={`${base} bg-red-500/[0.15] text-red-400 border border-red-500/[0.25] animate-pulse`}><Skull className="w-3 h-3" />{alerta.dias}d</span>; return null; };

  // ===== TOKENS VISUALES AAA =====
  const T = {
    surface: "bg-white/[0.03] border border-white/[0.08] shadow-[0_18px_40px_rgba(0,0,0,0.35),inset_0_1px_0_rgba(255,255,255,0.06)]",
    surfaceHeader: "bg-white/[0.04] border-b border-white/[0.06]",
    input: "bg-white/[0.04] border border-white/[0.08] text-white placeholder:text-white/30 focus:outline-none focus:border-white/[0.16] transition-all duration-150",
    btn: "bg-white/[0.04] border border-white/[0.08] text-white/60 hover:bg-white/[0.08] hover:text-white/80 transition-all duration-150",
    btnActive: "bg-white/[0.10] border border-white/[0.14] text-white/90",
    btnAction: "p-1.5 rounded-md bg-white/[0.04] border border-white/[0.08] text-white/60 hover:bg-white/[0.08] hover:text-white transition-all duration-150",
    btnEdit: "p-1.5 rounded-md bg-white/[0.04] border border-white/[0.08] text-white/60 hover:bg-amber-500/[0.14] hover:border-amber-500/[0.28] hover:text-amber-400 transition-all duration-150",
    btnDelete: "p-1.5 rounded-md bg-white/[0.04] border border-white/[0.08] text-white/60 hover:bg-red-500/[0.14] hover:border-red-500/[0.28] hover:text-red-400 transition-all duration-150",
    badge: "px-2 py-0.5 rounded text-xs font-medium bg-white/[0.08] border border-white/[0.10] text-white/75 shadow-[0_2px_8px_rgba(0,0,0,0.25)]",
    badgeSuccess: "px-2 py-0.5 rounded text-xs font-semibold bg-emerald-500/[0.12] border border-emerald-500/[0.18] text-emerald-400/90 shadow-[0_2px_8px_rgba(0,0,0,0.25)]",
    row: "border-b border-white/[0.04] border-l-2 border-l-transparent hover:border-l-blue-500/50 hover:bg-white/[0.04] transition-all duration-150",
    rowZebra: "bg-white/[0.025]",
  };

  return (
    <ModuleTemplate title="Panel de Oportunidades" onBack={onBack}>
      <div className="flex flex-col h-[calc(100vh-120px)]">
        {/* FILTROS con lÃ­nea divisoria */}
        <div className="flex-shrink-0 p-4 pb-3 border-b border-white/[0.06]">
          <div className="flex flex-wrap gap-3 items-center justify-between">
            <div className="flex-1 min-w-[300px]"><div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/30" /><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Buscar leads..." className={`w-full pl-10 pr-4 py-1.5 rounded-lg ${T.input}`} style={{ fontFamily: "'Exo 2', sans-serif", fontSize: '13px' }} /></div></div>
            <div className="flex gap-3">
              <select value={filterVendedor} onChange={(e) => setFilterVendedor(e.target.value)} className={`px-3 py-1.5 rounded-lg ${T.input}`} style={{ fontFamily: "'Exo 2', sans-serif", fontSize: '13px' }}><option value="">Todos los vendedores</option>{getVendedoresUnicos().map(v => <option key={v} value={v}>{v}</option>)}</select>
              <input type="date" value={filterFecha} onChange={(e) => setFilterFecha(e.target.value)} className={`px-3 py-1.5 rounded-lg ${T.input}`} style={{ fontFamily: "'Exo 2', sans-serif", fontSize: '13px' }} />
            </div>
            <div className="flex gap-3">
              {isAdmin && <button onClick={() => setShowDeleted(!showDeleted)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg ${showDeleted ? T.btnActive : T.btn}`} style={{ fontFamily: "'Exo 2', sans-serif", fontSize: '13px', fontWeight: 500 }}><Trash2 className="w-4 h-4" />{showDeleted ? 'Ocultar' : 'Ver eliminados'}</button>}
              <button onClick={() => setShowFunnel(!showFunnel)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg ${showFunnel ? T.btnActive : T.btn}`} style={{ fontFamily: "'Exo 2', sans-serif", fontSize: '13px', fontWeight: 500 }}><BarChart3 className="w-4 h-4" />Funnel</button>
              <button onClick={handleExportExcel} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg ${T.btn}`} style={{ fontFamily: "'Exo 2', sans-serif", fontSize: '13px', fontWeight: 500 }}><Download className="w-4 h-4" />Exportar</button>
            </div>
          </div>
        </div>

        {/* FUNNEL */}
        {showFunnel && (
          <div className={`flex-shrink-0 mx-4 mt-3 mb-2 p-4 rounded-2xl ${T.surface}`}>
            <h3 className="text-white/90 mb-3" style={{ fontFamily: "'Exo 2', sans-serif", fontSize: '18px', fontWeight: 600 }}>Funnel de Ventas</h3>
            <div className="grid grid-cols-5 gap-3">
              <div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 mb-1 uppercase tracking-wide" style={{ fontSize: '10px' }}>Total</div><div className="text-white" style={{ fontFamily: "'Orbitron', sans-serif", fontSize: '28px', fontWeight: 700 }}>{leads.filter(l => !l.eliminado).length}</div></div>
              <div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 mb-1 uppercase tracking-wide" style={{ fontSize: '10px' }}>Cotizados</div><div className="text-white" style={{ fontFamily: "'Orbitron', sans-serif", fontSize: '28px', fontWeight: 700 }}>{leads.filter(l => !l.eliminado && l.etapaLead === 'Cotizado').length}</div></div>
              <div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 mb-1 uppercase tracking-wide" style={{ fontSize: '10px' }}>Cerrados</div><div className="text-white" style={{ fontFamily: "'Orbitron', sans-serif", fontSize: '28px', fontWeight: 700 }}>{leads.filter(l => !l.eliminado && l.etapaLead === 'Cerrado').length}</div></div>
              <div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 mb-1 uppercase tracking-wide" style={{ fontSize: '10px' }}>$ Potencial</div><div className="text-emerald-400/90" style={{ fontFamily: "'Orbitron', sans-serif", fontSize: '18px', fontWeight: 700 }}>${leads.filter(l => !l.eliminado).reduce((sum, l) => sum + calcularPotencialDesdeCotizaciones(l), 0).toLocaleString('es-MX')}</div></div>
              <div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 mb-1 uppercase tracking-wide" style={{ fontSize: '10px' }}>En Riesgo</div><div className="text-white" style={{ fontFamily: "'Orbitron', sans-serif", fontSize: '28px', fontWeight: 700 }}>{leads.filter(l => !l.eliminado && getAlertaLead(l).tipo !== null).length}</div></div>
            </div>
          </div>
        )}

        {/* TABLA = SURFACE PREMIUM */}
        <div className={`flex-1 mx-4 my-3 rounded-2xl overflow-hidden flex flex-col ${T.surface}`}>
          {/* Header tabla */}
          <div className={`flex-shrink-0 ${T.surfaceHeader}`}>
            <table className="w-full"><thead><tr>
              <th className="px-2 py-3 text-center text-white/40 uppercase tracking-wider" style={{ fontSize: '10px', fontWeight: 600, width: '3%' }}>#</th>
              <th onClick={() => handleSort('nombreEmpresa')} className="px-2 py-3 text-left text-white/40 uppercase tracking-wider cursor-pointer hover:text-white/60 transition-colors" style={{ fontSize: '10px', fontWeight: 600, width: '18%' }}><div className="flex items-center gap-1"><Building2 className="w-3 h-3" />Empresa<SortIcon field="nombreEmpresa" /></div></th>
              <th className="px-1.5 py-3 text-left text-white/40 uppercase tracking-wider" style={{ fontSize: '10px', fontWeight: 600, width: '7%' }}>Etapa</th>
              <th className="px-2 py-3 text-left text-white/40 uppercase tracking-wider" style={{ fontSize: '10px', fontWeight: 600, width: '14%' }}>Contacto</th>
              <th className="px-2 py-3 text-left text-white/40 uppercase tracking-wider" style={{ fontSize: '10px', fontWeight: 600, width: '10%' }}>Servicio</th>
              <th className="px-1.5 py-3 text-left text-white/40 uppercase tracking-wider" style={{ fontSize: '10px', fontWeight: 600, width: '10%' }}>Viaje</th>
              <th className="px-1.5 py-3 text-left text-white/40 uppercase tracking-wider" style={{ fontSize: '10px', fontWeight: 600, width: '12%' }}>$ Potencial</th>
              <th onClick={() => handleSort('vendedor')} className="px-2 py-3 text-left text-white/40 uppercase tracking-wider cursor-pointer hover:text-white/60 transition-colors" style={{ fontSize: '10px', fontWeight: 600, width: '10%' }}><div className="flex items-center gap-1"><User className="w-3 h-3" />Vendedor<SortIcon field="vendedor" /></div></th>
              <th onClick={() => handleSort('fechaCaptura')} className="px-2 py-3 text-left text-white/40 uppercase tracking-wider cursor-pointer hover:text-white/60 transition-colors" style={{ fontSize: '10px', fontWeight: 600, width: '8%' }}><div className="flex items-center gap-1"><Calendar className="w-3 h-3" />Creado<SortIcon field="fechaCaptura" /></div></th>
              <th className="px-2 py-3 text-center text-white/40 uppercase tracking-wider" style={{ fontSize: '10px', fontWeight: 600, width: '8%' }}>Acciones</th>
            </tr></thead></table>
          </div>
          
          {/* Filas con zebra + hover */}
          <div className="flex-1 overflow-y-auto">
            <table className="w-full"><tbody>
              {filteredLeads.length === 0 ? (<tr><td colSpan={10} className="px-6 py-12 text-center text-white/30">No se encontraron leads.</td></tr>) : (
                filteredLeads.map((lead, index) => {
                  const alerta = getAlertaLead(lead);
                  const potencial = calcularPotencialDesdeCotizaciones(lead);
                  return (
                    <tr key={lead.id} className={`${T.row} ${index % 2 === 0 ? T.rowZebra : ''} ${lead.eliminado ? 'opacity-50' : ''} ${alerta.tipo === 'critico' ? 'bg-red-500/[0.03]' : ''}`} style={{ height: '52px' }}>
                      <td className="px-2 py-2 text-center" style={{ fontFamily: "'Orbitron', monospace", fontSize: '11px', fontWeight: 600, color: lead.eliminado || alerta.tipo === 'critico' ? 'rgba(239,68,68,0.7)' : 'rgba(59,130,246,0.7)', width: '3%' }}>{index + 1}</td>
                      <td className="px-2 py-2" style={{ width: '18%' }}><div className="flex items-center justify-between gap-2"><span className="text-white/90 truncate" style={{ fontSize: '11px', fontWeight: 600 }}>{lead.nombreEmpresa}</span><AlertBadge lead={lead} /></div></td>
                      <td className="px-1.5 py-2" style={{ width: '7%' }}><span className={T.badge} style={{ fontSize: '10px' }}>{lead.etapaLead || 'Prospecto'}</span></td>
                      <td className="px-2 py-2" style={{ width: '14%' }}><div style={{ fontSize: '11px' }}><div className="text-white/85 font-medium truncate">{lead.nombreContacto}</div><div className="text-white/40 truncate" style={{ fontSize: '10px' }}>{lead.correoElectronico}</div></div></td>
                      <td className="px-2 py-2" style={{ width: '10%' }}><div className="flex flex-wrap gap-0.5">{(lead.tipoServicio || []).slice(0,2).map((t, i) => <span key={i} className={T.badge} style={{ fontSize: '9px' }}>{t}</span>)}</div></td>
                      <td className="px-1.5 py-2" style={{ width: '10%' }}><div className="flex flex-wrap gap-0.5">{(lead.tipoViaje || []).slice(0,2).map((t, i) => <span key={i} className={T.badge} style={{ fontSize: '9px' }}>{t}</span>)}</div></td>
                      <td className="px-1.5 py-2" style={{ width: '12%' }}>{potencial > 0 ? <span className={T.badgeSuccess} style={{ fontFamily: "'Orbitron', monospace", fontSize: '10px' }}>${potencial.toLocaleString('es-MX')}</span> : <span className="text-white/20" style={{ fontSize: '10px' }}>-</span>}</td>
                      <td className="px-2 py-2 text-white/50" style={{ fontSize: '11px', width: '10%' }}>{lead.vendedor}</td>
                      <td className="px-2 py-2" style={{ width: '8%' }}><span className="text-white/50" style={{ fontSize: '10px' }}>{formatDate(lead.fechaCaptura)}</span></td>
                      <td className="px-2 py-2" style={{ width: '8%' }}>
                        <div className="flex items-center justify-center gap-1">
                          <button onClick={() => setSelectedLead(lead)} className={T.btnAction} title="Ver"><Eye className="w-3.5 h-3.5" /></button>
                          <button onClick={() => setEditLead(lead)} className={T.btnEdit} disabled={lead.eliminado} title="Editar"><Pencil className="w-3.5 h-3.5" /></button>
                          <div className="relative"><button onClick={() => setCotizacionesModal(lead)} className={T.btnAction} title="Cotizaciones"><FileText className="w-3.5 h-3.5" /></button>{lead.cotizaciones?.filter(c => !c.eliminado).length ? <div className="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-blue-500/80 flex items-center justify-center text-white" style={{ fontSize: '9px', fontWeight: 700 }}>{lead.cotizaciones.filter(c => !c.eliminado).length}</div> : null}</div>
                          {lead.eliminado && isAdmin ? <button onClick={() => handleRestaurarLead(lead)} className={T.btnAction} title="Restaurar"><TrendingUp className="w-3.5 h-3.5" /></button> : <button onClick={() => setDeleteModal(lead)} className={T.btnDelete} disabled={lead.eliminado} title="Eliminar"><Trash2 className="w-3.5 h-3.5" /></button>}
                        </div>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody></table>
          </div>
          {/* Footer tabla */}
          <div className={`flex-shrink-0 px-4 py-2 ${T.surfaceHeader}`}><span className="text-white/30" style={{ fontSize: '12px' }}>Mostrando {filteredLeads.length} de {leads.filter(l => !l.eliminado).length} leads</span></div>
        </div>
      </div>

      {/* MODALES */}
      {selectedLead && (<div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setSelectedLead(null)}><div className={`bg-slate-900 rounded-2xl w-[95vw] max-w-[1100px] max-h-[90vh] overflow-y-auto p-6 ${T.surface}`} onClick={(e) => e.stopPropagation()}><div className="flex items-center justify-between mb-4"><h3 className="text-white text-xl font-bold flex items-center gap-2"><Building2 className="w-6 h-6 text-blue-400/70" />{selectedLead.nombreEmpresa}</h3><button onClick={() => setSelectedLead(null)} className="p-2 rounded-lg hover:bg-white/[0.08] transition-colors"><X className="w-5 h-5 text-white/60" /></button></div><div className="grid grid-cols-2 gap-4 mb-4"><div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="flex items-center gap-2 text-white/40 text-xs mb-1"><Calendar className="w-3 h-3" />CreaciÃ³n</div><div className="text-white font-semibold">{formatDateTime(selectedLead.fechaCaptura)}</div></div><div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="flex items-center gap-2 text-white/40 text-xs mb-1"><Clock className="w-3 h-3" />Ãšltima ModificaciÃ³n</div><div className="text-white font-semibold">{formatDateTime(selectedLead.fechaActualizacion) || formatDateTime(selectedLead.fechaCaptura)}</div></div></div><div className="grid grid-cols-3 gap-4 text-sm mb-4"><div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 text-xs mb-1">Contacto</div><div className="text-white font-semibold">{selectedLead.nombreContacto}</div><div className="text-white/40">{selectedLead.correoElectronico}</div></div><div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 text-xs mb-1">Servicio</div><div className="flex flex-wrap gap-1">{(selectedLead.tipoServicio||[]).map((t,i)=><span key={i} className={T.badge}>{t}</span>)}</div></div><div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 text-xs mb-1">Viaje</div><div className="flex flex-wrap gap-1">{(selectedLead.tipoViaje||[]).map((t,i)=><span key={i} className={T.badge}>{t}</span>)}</div></div><div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08] col-span-2"><div className="text-white/40 text-xs mb-1">Rutas</div><div className="text-white text-sm">{selectedLead.principalesRutas || '-'}</div></div><div className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="text-white/40 text-xs mb-1">Viajes/Mes</div><div className="text-white font-bold text-lg">{selectedLead.viajesPorMes || '-'}</div></div></div>{(() => { const pot = calcularPotencialDesdeCotizaciones(selectedLead); return pot > 0 ? <div className="p-4 rounded-lg bg-emerald-500/[0.08] border border-emerald-500/[0.15] mb-4"><div className="text-emerald-400/60 text-xs mb-1">$ Potencial Mensual</div><div className="text-emerald-400/90 font-bold text-3xl">${pot.toLocaleString('es-MX')} MXN</div></div> : null; })()}{selectedLead.cotizaciones && selectedLead.cotizaciones.filter(c => !c.eliminado).length > 0 && (<div className="mb-4"><h4 className="text-white font-semibold mb-2 flex items-center gap-2"><FileText className="w-4 h-4 text-white/50" />Cotizaciones</h4><div className="space-y-2">{selectedLead.cotizaciones.filter(c => !c.eliminado).map((cot, i) => (<div key={i} className="p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="flex justify-between items-center mb-2"><span className="text-white font-medium">{cot.nombre}</span><span className="text-white/30 text-xs">{formatDate(cot.fecha)}</span></div>{cot.lineas && cot.lineas.length > 0 && (<div className="space-y-1">{cot.lineas.map((linea, idx) => (<div key={idx} className="flex justify-between text-xs text-white/40"><span>{linea.origen} â†’ {linea.destino} ({linea.tipoViaje})</span><span>{linea.viajes} Ã— ${linea.tarifa.toLocaleString('es-MX')} {linea.moneda} = <span className="text-emerald-400/80">${linea.subtotalMXN.toLocaleString('es-MX')}</span></span></div>))}<div className="pt-2 border-t border-white/[0.06] flex justify-between text-sm"><span className="text-emerald-400/50">Total:</span><span className="text-emerald-400/90 font-bold">${cot.potencialMXN?.toLocaleString('es-MX')}</span></div></div>)}</div>))}</div></div>)}{selectedLead.historial && selectedLead.historial.length > 0 && (<div className="mb-4"><h4 className="text-white font-semibold mb-2 flex items-center gap-2"><Clock className="w-4 h-4 text-white/40" />Historial</h4><div className="max-h-40 overflow-y-auto space-y-1">{selectedLead.historial.slice().reverse().map((h, i) => (<div key={i} className="flex items-center gap-3 text-xs p-2 rounded bg-white/[0.04]"><span className="text-white/25">{formatDateTime(h.fecha)}</span><span className="text-white/50">{h.campo}</span><span className="text-white/40">{h.valorNuevo}</span><span className="text-white/25 ml-auto">{h.usuario}</span></div>))}</div></div>)}<div className="flex justify-between items-center text-sm text-white/30"><span>Vendedor: {selectedLead.vendedor}</span><span>Etapa: {selectedLead.etapaLead || 'Prospecto'}</span></div></div></div>)}

      {deleteModal && (<div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => { setDeleteModal(null); setDeleteConfirmText(''); }}><div className={`bg-slate-900 rounded-2xl w-[400px] p-6 border border-red-500/[0.20] shadow-[0_18px_40px_rgba(0,0,0,0.4)]`} onClick={(e) => e.stopPropagation()}><div className="flex items-center gap-3 mb-4"><AlertTriangle className="w-8 h-8 text-red-400/70" /><h3 className="text-white text-lg font-bold">Eliminar Lead</h3></div><p className="text-white mb-2">Â¿Eliminar <strong>{deleteModal.nombreEmpresa}</strong>?</p><p className="text-white/40 text-sm mb-4">Escribe DELETE:</p><input type="text" value={deleteConfirmText} onChange={(e) => setDeleteConfirmText(e.target.value.toUpperCase())} className={`w-full px-4 py-2 rounded-lg text-center mb-4 ${T.input}`} /><div className="flex gap-3"><button onClick={() => { setDeleteModal(null); setDeleteConfirmText(''); }} className={`flex-1 px-4 py-2 rounded-lg ${T.btn}`}>Cancelar</button><button onClick={handleConfirmarEliminacion} disabled={deleteConfirmText !== 'DELETE'} className={`flex-1 px-4 py-2 rounded-lg transition-colors ${deleteConfirmText === 'DELETE' ? 'bg-red-500/[0.18] border border-red-500/[0.28] text-red-400 hover:bg-red-500/[0.25]' : 'bg-white/[0.04] border border-white/[0.08] text-white/25 cursor-not-allowed'}`}>Eliminar</button></div></div></div>)}

      {cotizacionesModal && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setCotizacionesModal(null)}><div className={`bg-slate-900 rounded-2xl w-[900px] max-h-[85vh] overflow-y-auto p-6 ${T.surface}`} onClick={(e) => e.stopPropagation()}><div className="flex items-center justify-between mb-4"><h3 className="text-white text-xl font-bold flex items-center gap-2"><FileText className="w-5 h-5 text-white/50" />Cotizaciones - {cotizacionesModal.nombreEmpresa}</h3><button onClick={() => setCotizacionesModal(null)} className="p-2 rounded-lg hover:bg-white/[0.08] transition-colors"><X className="w-5 h-5 text-white/60" /></button></div><div className="mb-4"><label className={`flex items-center justify-center gap-2 px-4 py-3 rounded-xl cursor-pointer transition-colors ${analizando ? 'bg-blue-500/[0.18] text-blue-400' : 'bg-white/[0.06] border border-white/[0.10] text-white/70 hover:bg-white/[0.10]'}`}>{analizando ? <><Loader2 className="w-5 h-5 animate-spin" /><span>{statusMsg}</span></> : <><Upload className="w-5 h-5" /><span className="font-semibold">Subir CotizaciÃ³n (PDF)</span></>}<input type="file" accept="application/pdf" className="hidden" disabled={analizando} onChange={(e) => { if (e.target.files?.length) handleSubirCotizaciones(e.target.files, cotizacionesModal); e.target.value = ''; }} /></label></div><div className="space-y-3">{(!cotizacionesModal.cotizaciones || !cotizacionesModal.cotizaciones.filter(c => !c.eliminado).length) ? (<div className="text-center py-6 text-white/30">No hay cotizaciones.</div>) : (cotizacionesModal.cotizaciones.filter(c => !c.eliminado).map((cot, i) => (<div key={i} className="p-4 rounded-lg bg-white/[0.04] border border-white/[0.08]"><div className="flex items-center justify-between mb-2"><div className="flex items-center gap-2"><FileText className="w-4 h-4 text-white/40" /><span className="text-white font-semibold">{cot.nombre}</span><span className="text-white/25 text-xs">{formatDate(cot.fecha)}</span></div><div className="flex gap-2">{cot.url && <button onClick={() => setPdfPreview(cot.url)} className={T.btnAction}><Eye className="w-3 h-3" /></button>}{cot.url && <a href={cot.url} download={cot.nombre} className={T.btnAction}><Download className="w-3 h-3" /></a>}<button onClick={() => handleEliminarCotizacion(cotizacionesModal, cotizacionesModal.cotizaciones?.indexOf(cot) || i)} className={T.btnDelete}><Trash2 className="w-3 h-3" /></button></div></div>{cot.lineas && cot.lineas.length > 0 && (<div className="mt-3 p-3 rounded bg-emerald-500/[0.06] border border-emerald-500/[0.12]"><div className="flex items-center gap-1 mb-2"><CheckCircle className="w-3 h-3 text-emerald-400/60" /><span className="text-emerald-400/60 text-xs font-semibold">LÃ­neas Cotizadas</span></div><div className="space-y-2">{cot.lineas.map((linea, idx) => (<div key={idx} className="flex justify-between items-center text-xs p-2 rounded bg-white/[0.04]"><div className="flex-1 flex items-center gap-2"><MapPin className="w-3 h-3 text-white/25" /><span className="text-white/70">{linea.origen}</span><ArrowRight className="w-3 h-3 text-white/25" /><span className="text-white/70">{linea.destino}</span><span className={T.badge}>{linea.tipoViaje}</span></div><div className="text-white/40">{linea.viajes} Ã— ${linea.tarifa.toLocaleString('es-MX')} {linea.moneda}</div><div className="text-emerald-400/80 font-semibold ml-4">${linea.subtotalMXN.toLocaleString('es-MX')}</div></div>))}</div><div className="mt-3 pt-3 border-t border-emerald-500/[0.12] flex justify-between items-center"><span className="text-emerald-400/50 font-semibold">TOTAL:</span><span className="text-emerald-400/90 font-bold text-xl">${cot.potencialMXN?.toLocaleString('es-MX')}</span></div></div>)}</div>)))}</div><button onClick={() => setCotizacionesModal(null)} className={`mt-4 w-full px-4 py-2 rounded-lg ${T.btn}`}>Cerrar</button></div></div>)}

      {lineasModal && (<div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[60] p-4"><div className={`bg-slate-900 rounded-2xl w-[800px] max-h-[90vh] overflow-y-auto p-6 ${T.surface}`}><div className="flex items-center justify-between mb-4"><h3 className="text-white text-lg font-bold flex items-center gap-2"><DollarSign className="w-5 h-5 text-white/50" />Capturar Viajes por Ruta</h3><button onClick={() => { setLineasModal(null); setLineasCotizacion([]); }} className="p-2 rounded-lg hover:bg-white/[0.08] transition-colors"><X className="w-5 h-5 text-white/60" /></button></div><div className="mb-4 p-3 rounded-lg bg-white/[0.04] border border-white/[0.08]"><p className="text-white/50 text-sm">Captura los <strong className="text-white/70">viajes potenciales por mes</strong> para cada ruta.</p></div><div className="space-y-3 mb-4">{lineasCotizacion.map((linea, idx) => (<div key={idx} className="p-4 rounded-xl bg-white/[0.04] border border-white/[0.08]"><div className="flex items-center justify-between mb-3"><div className="flex items-center gap-2"><MapPin className="w-4 h-4 text-white/40" /><span className="text-white font-semibold">{linea.origen || 'Sin origen'}</span><span className="text-white/25">â†’</span><span className="text-white font-semibold">{linea.destino || 'Sin destino'}</span></div><span className={T.badge}>{linea.tipoViaje}</span></div><div className="flex items-center justify-between"><div className="flex items-center gap-4 text-sm"><span className="text-white/40"><Truck className="w-4 h-4 inline mr-1" />{linea.servicio}</span><span className="text-white/60 font-bold">${linea.tarifa?.toLocaleString('es-MX')} {linea.moneda}</span></div><div className="flex items-center gap-2"><label className="text-white/40 text-sm">Viajes/mes:</label><input type="number" min="0" value={linea.viajes || ''} onChange={(e) => handleCambioLinea(idx, 'viajes', parseInt(e.target.value) || 0)} placeholder="0" className={`w-20 px-3 py-2 rounded-lg text-center font-bold text-lg ${linea.viajes > 0 ? 'bg-white/[0.08] border-white/[0.18] text-white' : 'bg-white/[0.04] border-white/[0.08] text-white/40'} border focus:outline-none`} style={{ MozAppearance: 'textfield' }} /></div></div></div>))}</div><div className="p-4 rounded-xl bg-emerald-500/[0.08] border border-emerald-500/[0.15] mb-4"><div className="flex justify-between items-center"><span className="text-emerald-400/60 font-semibold text-lg">POTENCIAL MENSUAL:</span><span className="text-emerald-400/90 font-bold text-3xl" style={{ fontFamily: "'Orbitron', monospace" }}>${calcularTotalMXN().toLocaleString('es-MX')} MXN</span></div></div><div className="flex gap-3"><button onClick={() => { setLineasModal(null); setLineasCotizacion([]); }} className={`flex-1 px-4 py-3 rounded-lg ${T.btn}`}>Cancelar</button><button onClick={handleGuardarCotizacion} disabled={!todosViajesCapturados()} className={`flex-1 px-4 py-3 rounded-lg font-bold text-lg transition-colors ${todosViajesCapturados() ? 'bg-white/[0.10] border border-white/[0.14] text-white hover:bg-white/[0.14]' : 'bg-white/[0.04] border border-white/[0.08] text-white/25 cursor-not-allowed'}`}>{todosViajesCapturados() ? 'âœ“ Guardar' : 'Captura viajes'}</button></div></div></div>)}

      {pdfPreview && (<div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[60] p-4" onClick={() => setPdfPreview(null)}><div className="bg-white rounded-2xl w-[90vw] h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}><div className="flex items-center justify-between p-3 bg-slate-100 border-b"><span className="text-slate-700 font-semibold">Vista previa</span><button onClick={() => setPdfPreview(null)} className="p-2 rounded-lg hover:bg-slate-200 transition-colors"><X className="w-5 h-5 text-slate-600" /></button></div><iframe src={pdfPreview} className="flex-1 w-full" title="PDF" /></div></div>)}

      {editLead && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setEditLead(null)}><div className={`bg-slate-900 rounded-2xl w-[700px] max-h-[80vh] overflow-y-auto p-6 ${T.surface}`} onClick={(e) => e.stopPropagation()}><div className="flex items-center justify-between mb-4"><h3 className="text-white text-xl font-bold flex items-center gap-2"><Pencil className="w-5 h-5 text-white/50" />Editar - {editLead.nombreEmpresa}</h3><button onClick={() => setEditLead(null)} className="p-2 rounded-lg hover:bg-white/[0.08] transition-colors"><X className="w-5 h-5 text-white/60" /></button></div><div className="grid grid-cols-2 gap-3 text-sm"><div><label className="text-white/40 text-xs">Empresa</label><input type="text" value={formData.nombreEmpresa || ''} onChange={(e) => setFormData({ ...formData, nombreEmpresa: e.target.value })} className={`w-full mt-1 px-3 py-2 rounded-lg ${T.input}`} /></div><div><label className="text-white/40 text-xs">Web</label><input type="text" value={formData.paginaWeb || ''} onChange={(e) => setFormData({ ...formData, paginaWeb: e.target.value })} className={`w-full mt-1 px-3 py-2 rounded-lg ${T.input}`} /></div><div><label className="text-white/40 text-xs">Contacto</label><input type="text" value={formData.nombreContacto || ''} onChange={(e) => handleInputChange('nombreContacto', e.target.value)} className={`w-full mt-1 px-3 py-2 rounded-lg ${T.input}`} /></div><div><label className="text-white/40 text-xs">Email</label><input type="email" value={formData.correoElectronico || ''} onChange={(e) => handleInputChange('correoElectronico', e.target.value)} className={`w-full mt-1 px-3 py-2 rounded-lg ${T.input}`} /></div><div className="col-span-2"><label className="text-white/40 text-xs">Servicio</label><div className="flex flex-wrap gap-2 mt-1">{['Seco', 'Refrigerado', 'Seco Hazmat', 'Refrigerado Hazmat'].map(s => <button key={s} onClick={() => handleToggleServicio(s)} className={`px-3 py-1 rounded text-xs transition-all ${formData.tipoServicio?.includes(s) ? 'bg-white/[0.12] border border-white/[0.18] text-white/90' : 'bg-white/[0.04] border border-white/[0.08] text-white/40 hover:text-white/60'}`}>{s}</button>)}</div></div><div className="col-span-2"><label className="text-white/40 text-xs">Viaje</label><div className="flex flex-wrap gap-2 mt-1">{['Impo', 'Expo', 'Nacional', 'DTD', 'Dedicado'].map(v => <button key={v} onClick={() => handleToggleViaje(v)} className={`px-3 py-1 rounded text-xs transition-all ${formData.tipoViaje?.includes(v) ? 'bg-white/[0.12] border border-white/[0.18] text-white/90' : 'bg-white/[0.04] border border-white/[0.08] text-white/40 hover:text-white/60'}`}>{v}</button>)}</div></div><div className="col-span-2"><label className="text-white/40 text-xs">Rutas</label><input type="text" value={formData.principalesRutas || ''} onChange={(e) => setFormData({ ...formData, principalesRutas: e.target.value })} className={`w-full mt-1 px-3 py-2 rounded-lg ${T.input}`} /></div><div><label className="text-white/40 text-xs">Viajes/Mes</label><input type="number" value={formData.viajesPorMes || ''} onChange={(e) => setFormData({ ...formData, viajesPorMes: e.target.value })} className={`w-full mt-1 px-3 py-2 rounded-lg ${T.input}`} /></div><div><label className="text-white/40 text-xs">Etapa</label><select value={formData.etapaLead || 'Prospecto'} onChange={(e) => setFormData({ ...formData, etapaLead: e.target.value })} className={`w-full mt-1 px-3 py-2 rounded-lg ${T.input}`}><option>Prospecto</option><option>Cotizado</option><option>NegociaciÃ³n</option><option>Cerrado</option></select></div><div className="col-span-2"><label className="text-white/40 text-xs">PrÃ³ximos Pasos</label><input type="text" value={formData.proximosPasos || ''} onChange={(e) => setFormData({ ...formData, proximosPasos: e.target.value })} className={`w-full mt-1 px-3 py-2 rounded-lg ${T.input}`} /></div></div><div className="flex gap-3 mt-4"><button onClick={() => setEditLead(null)} className={`flex-1 px-4 py-2 rounded-lg ${T.btn}`}>Cancelar</button><button onClick={handleGuardarEdicion} className="flex-1 px-4 py-2 rounded-lg bg-white/[0.10] border border-white/[0.14] text-white font-semibold hover:bg-white/[0.14] transition-colors">Guardar</button></div></div></div>)}
    </ModuleTemplate>
  );
};
